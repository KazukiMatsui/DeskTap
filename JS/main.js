var music_scale;
var music_length;
var ToneBPM = 90;
var BPNConvertMSEC = 60 / ToneBPM * 1000;
Tone.Transport.bpm.value = ToneBPM;
console.log(BPNConvertMSEC);

var count = 0;
/*
var melody_length_ary1 = [
    0.182291666666667,0.172916666666667,0.195833333333333,0.189583333333333,0.2,0.161979166666667,0.172916666666667,0.190104166666667,0.352083333333333,0.182291666666667,0.1609375,0.208854166666667,0.31875,0.1859375,0.190104166666667,0.189583333333333,
    0.347395833333333,0.141666666666667,0.175,0.178645833333333,0.179166666666667,0.184375,0.180729166666667,0.182291666666667,0.172916666666667,0.1953125,0.344791666666667,0.1671875,0.172916666666667,0.191666666666667,0.328645833333333,0.184375,
    0.165625,0.179166666666667,0.578645833333333,0.1453125,0.178645833333333,0.188541666666667,0.168229166666667,0.197395833333333,0.178645833333333,0.169270833333333,0.1859375,0.3453125,0.190104166666667,0.160416666666667,0.1953125,0.335416666666667,
    0.178645833333333,0.202083333333333,0.189583333333333,0.335416666666667,0.138541666666667,0.172916666666667,0.178645833333333,0.175,0.2015625,0.2203125,0.183333333333333,0.161979166666667,0.202604166666667,0.3375,0.15625,0.168229166666667,
    0.184895833333333,0.321354166666667,0.190625,0.178645833333333,0.178645833333333,0.4140625,0.205729166666667,0.201041666666667,0.195833333333333,0.375,0.171875,0.199479166666667,0.188020833333333,0.352083333333333,0.172916666666667,0.207291666666667,
    0.2125,0.324479166666667,0.189583333333333,0.211979166666667,0.21875,0.36875,0.0744791666666667,0.1515625,0.279166666666667,0.100520833333333,0.1625,0.279166666666667,0.2015625,0.1609375,0.245833333333333,0.1953125,
    0.178645833333333,0.1625,0.168229166666667,0.190625,0.179166666666667,0.172916666666667,0.1859375,0.211979166666667,0.160416666666667,0.161979166666667,0.205729166666667,0.31875,0.172916666666667,0.178645833333333,0.1828125,0.341145833333333,
    0.184895833333333,0.190625,0.2015625,0.314583333333333,0.1359375,0.172916666666667,0.168229166666667,0.178645833333333,0.178645833333333,0.199479166666667,0.1828125,0.179166666666667,0.184375,0.334375,0.1953125,0.160416666666667,
    0.191666666666667,0.3390625,0.1671875,0.179166666666667,0.229166666666667,2.03802083333333,2.025
];
var melody_time_ary1 = [
    3330,3663,3996,4329,4662,4995,5328,5661,5994,6993,7326,7659,7992,8991,9324,9657,
    9990,10989,11322,11655,11988,12321,12654,12987,13320,13653,13986,14985,15318,15651,15984,16983,
    17316,17649,17982,19314,19647,19980,20313,20646,20979,21312,21645,21978,22977,23310,23643,23976,
    24975,25308,25641,25974,26973,27306,27639,27972,28305,28638,28971,29304,29637,29970,30969,31302,
    31635,31968,32967,33300,33633,33966,34965,35298,35631,35964,36963,37296,37629,37962,38961,39294,
    39627,39960,40959,41292,41625,41958,42624,42957,43290,43956,44289,44622,44955,45288,45621,45954,
    46287,46620,46953,47286,47619,47952,48285,48618,48951,49284,49617,49950,50949,51282,51615,51948,
    52947,53280,53613,53946,54945,55278,55611,55944,56277,56610,56943,57276,57609,57942,58941,59274,
    59607,59940,60939,61272,61605,61938,61938
];
var melody_data1 = [
    'E5','D#5','E5','D#5','E5','B4','D5','C5','A4','C4','E4','A4','B4','E4','G#4','B4',
    'C5','E4','E5','D#5','E5','D#5','E5','B4','D5','C5','A4','C4','E4','A4','B4','E4',
    'C5','B4','A4','E5','D#5','E5','D#5','E5','B4','D5','C5','A4','C4','E4','A4','B4',
    'E4','G#4','B4','C5','E4','E5','D#5','E5','D#5','E5','B4','D5','C5','A4','C4','E4',
    'A4','B4','E4','C5','B4','A4','B4','C5','D5','E5','G4','F5','E5','D5','F4','E5',
    'D5','C5','E4','D5','C5','B4','E4','E4','E5','E5','E5','E6','D#5','E5','D#5','E5',
    'D#5','E5','D#5','E5','D#5','E5','D#5','E5','B4','D5','C5','A4','C4','E4','A4','B4',
    'E4','G#4','B4','C5','E4','E5','D#5','E5','D#5','E5','B4','D5','C5','A4','C4','E4',
    'A4','B4','D4','C5','B4','A4','C4'
];
var melody_length_ary2 = [
    0.369791666666667,0.643229166666667,0.370833333333333,0.669791666666667,0.341145833333333,0.659895833333333,0.328645833333333,0.6640625,0.353125,0.667708333333333,0.656770833333333,0.385416666666667,0.659895833333333,0.375,0.671875,0.335416666666667,
    0.660416666666667,0.3359375,0.665625,0.352083333333333,0.688020833333333,0.698958333333333,0.172916666666667,0.717708333333333,0.175,0.772395833333333,0.177083333333333,0.689583333333333,1.034375,1.07291666666667,0.351041666666667,0.653125,
    0.367708333333333,0.665625,0.3296875,0.647395833333333,0.3453125,0.666145833333333,0.36875,0.408333333333333,2.03802083333333,2.025
];
var melody_time_ary2 = [
    5999,6666,7998,8665,9997,10664,13994,14661,
    15993,16660,17992,21989,22656,23988,24655,25987,
    26654,29984,30651,31983,32650,33982,36314,36647,
    38312,38645,40310,40643,41975,41975,49969,50636,
    51968,52635,53967,54634,57964,58631,59963,60630,
    61962,61962
];
var melody_data2 = [
    'A3','E3','G#3','E3','A3','E3','A3','E3','G#3','E3','A3','A3','E3','G#3','E3','A3',
    'E3','A3','E3','G#3','E3','A3','G3','C4','G3','B3','A3','C4','E3','G#3','A3','E3',
    'G#3','E3','A3','E3','A3','E3','G#3','E3','A2','E3'
];
*/
//channel:1
//inst:72
var melody_length_ary1 = [
    0.121875,0.0578125,0.121354166666667,0.121354166666667,0.184895833333333,0.0791666666666667,0.121354166666667,0.184895833333333,0.184895833333333,0.121354166666667,0.184895833333333,0.121354166666667,0.184895833333333,0.184895833333333,0.311458333333333,0.2484375,
    0.502083333333333,0.121354166666667,0.184895833333333,0.184895833333333,0.2484375,0.121354166666667,0.184895833333333,0.184895833333333,0.121354166666667,0.184895833333333,0.0682291666666667,0.121354166666667,0.184895833333333,0.184895833333333,0.121354166666667,0.184895833333333,
    0.184895833333333,0.121354166666667,0.375520833333333,0.0583333333333333,0.375,1.009375,0.0578125,0.184895833333333,0.121354166666667,0.184895833333333,0.184895833333333,0.121354166666667,0.195833333333333,0.184895833333333,0.121354166666667,0.184895833333333,
    0.121354166666667,0.184895833333333,0.184895833333333,0.385416666666667,0.2484375,0.697916666666667,1.009375,0.184895833333333,0.121354166666667,0.121354166666667,0.121354166666667,1.009375,0.184895833333333,0.121354166666667,0.184895833333333,0.121354166666667,
    0.121354166666667,0.184895833333333,0.00520833333333333,0.121354166666667,0.502083333333333,0.184895833333333,0.121354166666667,0.0583333333333333,0.0583333333333333,0.6390625,0.121354166666667,0.184895833333333,0.184895833333333,0.121354166666667,0.184895833333333,0.184895833333333,
    0.121354166666667,0.184895833333333,0.184895833333333,0.121354166666667,0.184895833333333,0.121354166666667,0.121875,0.0578125,0.184895833333333,0.121354166666667,0.184895833333333,0.184895833333333,0.121354166666667,0.502083333333333,0.2484375,0.121354166666667,
    0.2484375,0.375520833333333,0.121875,0.121354166666667,0.2484375,0.502083333333333,0.121354166666667,0.184895833333333,0.184895833333333,0.121354166666667,0.184895833333333,0.184895833333333,0.121354166666667,0.755729166666667,0.502083333333333,0.0583333333333333,
    0.121354166666667,0.2484375,0.121354166666667,0.0578125,0.121354166666667,0.121354166666667,0.121354166666667,0.0578125,0.0583333333333333,0.121354166666667,0.0578125,0.0583333333333333,0.121354166666667,0.0578125,0.121875,0.121354166666667,
    0.0583333333333333,0.0583333333333333,0.121354166666667,0.2484375,0.121354166666667,0.2484375,0.2484375,0.0583333333333333,0.121354166666667,0.121875,0.121354166666667,0.2484375,0.121354166666667,0.2484375,0.502083333333333,0.121354166666667,
    0.2484375,0.121354166666667,0.629166666666667,0.121354166666667,0.2484375,0.121875,0.121354166666667,0.2484375,0.121354166666667,1.009375,0.0578125,0.0578125,0.0583333333333333,0.628645833333333,0.0578125,0.0578125,
    0.121875,0.121354166666667,0.121875,0.121354166666667,0.0578125,0.121875,0.628645833333333,0.121354166666667,0.121875,0.121354166666667,0.2484375,0.121875,0.502083333333333,0.2484375,0.0583333333333333,0.121354166666667,
    0.2484375,0.0583333333333333,0.0791666666666667,0.121354166666667,0.121354166666667,0.0578125,0.0578125,0.184895833333333,0.0578125,0.0583333333333333,0.121354166666667,0.0578125,0.121875,0.121354166666667,0.0583333333333333,0.0583333333333333,
    0.121354166666667,0.2484375,0.121354166666667,0.2484375,0.2484375,0.121354166666667,0.121875,0.121354166666667,0.121875,0.121354166666667,0.2484375,0.628645833333333,0.121354166666667,0.121875,0.121354166666667,0.121875,
    0.121354166666667,0.502083333333333,0.121354166666667,0.121875,0.121354166666667,0.0578125,0.2484375,0.121354166666667,0.375520833333333,0.0578125,0.0578125,0.0583333333333333,0.628645833333333,0.121354166666667,0.121875,0.121354166666667,
    1.009375,0.121354166666667,0.121875,0.628645833333333,0.121354166666667,0.121875,0.121354166666667,0.184895833333333,0.184895833333333,0.628645833333333,0.184895833333333,0.0578125,0.0578125,0.0583333333333333,0.121354166666667,0.184895833333333,
    0.184895833333333,0.121354166666667,0.184895833333333,0.184895833333333,0.121354166666667,0.184895833333333,0.184895833333333,0.184895833333333,0.184895833333333,0.375,0.2484375,0.502083333333333,0.121354166666667,1.009375,0.184895833333333,0.121354166666667,
    0.184895833333333,0.184895833333333,0.121354166666667,0.195833333333333,0.184895833333333,0.121354166666667,0.184895833333333,0.121354166666667,0.184895833333333,0.00520833333333333,0.121354166666667,0.184895833333333,0.184895833333333,0.121354166666667,0.0583333333333333,0.0583333333333333,
    0.6390625,0.121354166666667,0.184895833333333,0.184895833333333,0.121354166666667,0.184895833333333,0.184895833333333,0.121354166666667,0.184895833333333,0.184895833333333,0.121354166666667,0.121875,0.121354166666667,0.121354166666667,0.184895833333333,0.184895833333333,
    0.121354166666667,0.184895833333333,0.184895833333333,0.121354166666667,0.502083333333333,0.2484375,0.121354166666667,0.2484375,0.311979166666667,0.121354166666667,0.121875,0.121354166666667,0.184895833333333,0.502083333333333,0.121354166666667,0.184895833333333,
    0.184895833333333,0.121354166666667,0.184895833333333,0.184895833333333,0.121354166666667,0.755729166666667,0.502083333333333,0.0583333333333333,0.121354166666667,0.2484375,0.0583333333333333,0.0578125,0.121354166666667,0.121354166666667,0.0578125,0.0578125,
    0.184895833333333,0.0578125,0.0583333333333333,0.121354166666667,0.0578125,0.121875,0.121354166666667,0.0583333333333333,0.0583333333333333,0.121354166666667,0.2484375,0.121354166666667,0.2484375,0.2484375,0.121354166666667,0.121875,
    0.121354166666667,0.2484375,0.121354166666667,0.2484375,0.0583333333333333,0.121354166666667,0.0578125,0.0578125,0.2484375,0.121354166666667,0.502083333333333,0.121354166666667,0.2484375,0.121354166666667,0.121875,0.121354166666667,
    0.2484375,0.121354166666667,1.009375,0.0578125,0.0578125,0.0583333333333333,0.628645833333333,0.0578125,0.0578125,0.121875,0.121354166666667,0.121875,0.121354166666667,0.0578125,0.121875,0.628645833333333,
    0.121354166666667,0.121875,0.121354166666667,0.2484375,0.121875,0.502083333333333,0.2484375,0.0583333333333333,0.121354166666667,0.2484375,0.0583333333333333,0.0791666666666667,0.121354166666667,0.121354166666667,0.0578125,0.0578125,
    0.184895833333333,0.0578125,0.0583333333333333,0.121354166666667,0.0578125,0.121875,0.121354166666667,0.0583333333333333,0.0583333333333333,0.121354166666667,0.2484375,0.121354166666667,0.2484375,0.2484375,0.0578125,0.0578125,
    0.121875,0.121354166666667,1.009375,0.121354166666667,0.2484375,0.628645833333333,0.121354166666667,0.121875,0.121354166666667,0.121875,0.121354166666667,0.502083333333333,0.121354166666667,0.121875,0.121354166666667,0.2484375,
    0.121354166666667,0.375520833333333,0.0578125,0.0578125,0.0583333333333333,0.628645833333333,0.121354166666667,0.121875,0.121354166666667,1.009375,0.121875,0.628645833333333,0.121354166666667,0.121875,0.121354166666667,0.184895833333333,
    0.184895833333333,0.628645833333333,0.184895833333333,0.0578125,0.121875,0.121354166666667,0.121875,0.0578125,0.184895833333333,0.0578125,0.0578125,0.121875,0.121354166666667,0.121875,0.375,0.2484375,
    0.0578125,0.2484375,0.2484375,0.2484375,0.2484375,0.2484375,0.375,0.502083333333333,0.121354166666667,0.0578125,0.121875,0.375,0.184895833333333,0.0578125,0.06875,0.502083333333333,
    0.2484375,0.121875,0.2484375,0.121354166666667,0.184895833333333,0.184895833333333,0.2484375,0.184895833333333,0.81875,0.0583333333333333,0.0583333333333333,0.121354166666667,0.0583333333333333,0.121354166666667,0.0791666666666667,0.121354166666667,
    0.121354166666667,0.0578125,0.0791666666666667,0.0583333333333333,0.0578125,0.0578125,0.0583333333333333,0.121354166666667,0.0578125,0.121875,0.121354166666667,0.0583333333333333,0.0583333333333333,0.121354166666667,0.121875,0.121354166666667,
    0.06875,0.184895833333333,0.0583333333333333,0.121354166666667,0.121875,0.121354166666667,0.121875,0.121354166666667,0.2484375,0.0583333333333333,0.121354166666667,0.121354166666667,0.121875,0.121354166666667,0.121875,0.121354166666667,
    0.121875,0.121354166666667,0.121875,0.121354166666667,0.2484375,0.121354166666667,0.121875,0.0578125,0.0682291666666667,0.0583333333333333,0.121354166666667,0.0578125,0.0578125,0.121875,0.121354166666667,0.121875,
    0.0578125,0.0578125,0.121875,0.121354166666667,0.121354166666667,0.121875,0.121354166666667,0.375520833333333,0.00520833333333333,0.438541666666667,0.0583333333333333,0.0583333333333333,0.121354166666667,0.2484375,0.0583333333333333,0.0791666666666667,
    0.121354166666667,0.121354166666667,0.0578125,0.0578125,0.184895833333333,0.0578125,0.0583333333333333,0.121354166666667,0.0578125,0.121875,0.121354166666667,0.0583333333333333,0.0583333333333333,0.121354166666667,0.2484375,0.121354166666667,
    0.755729166666667,0.2484375,0.121354166666667,0.121875,0.121354166666667,1.009375,0.121354166666667,0.2484375,0.628645833333333,0.121354166666667,0.121875,0.121354166666667,0.121875,0.121354166666667,0.502083333333333,0.121354166666667,
    0.121875,0.121354166666667,0.0578125,0.2484375,0.121354166666667,0.375520833333333,0.0578125,0.0578125,0.0583333333333333,0.628645833333333,0.121354166666667,0.121875,0.121354166666667,1.009375,0.121354166666667,0.121875,
    0.628645833333333,0.121354166666667,0.121875,0.121354166666667,0.184895833333333,0.184895833333333,0.628645833333333
    ];
    var melody_time_ary1 = [
    0,244,366,731,974,1340,1705,1948,2314,2679,2922,3288,3896,4262,4627,5357,
    5844,7549,7792,8158,8523,9010,9740,10106,10471,10714,11080,11445,11688,12054,12419,12662,
    13028,13393,13636,13758,13880,15584,15828,15950,16315,16558,16924,17289,17532,17898,18263,18506,
    18872,19480,19846,20211,20941,21428,23376,23742,24107,24472,25081,25324,25690,26055,26298,26664,
    27029,27272,27638,28003,28246,28612,28977,29220,29342,29464,30925,31168,31534,31899,32142,32508,
    32873,33116,33482,33847,34090,34456,35064,35308,35430,35795,36038,36404,36769,37012,38473,38717,
    38960,39447,40421,40665,40908,41395,42613,42856,43222,43587,43830,44196,44561,44804,48213,48335,
    48457,48700,48822,49066,49309,49553,49918,50040,50283,50405,50527,50648,50770,51014,51135,51379,
    51622,51744,51866,52109,52353,52596,52840,53205,53327,53570,53814,54057,54301,54544,54788,55275,
    55518,55762,56005,56249,56492,56979,57223,57466,57710,57953,58197,58319,58562,58684,59171,59293,
    59414,59658,59901,60145,60267,60388,60632,61119,61362,61606,61849,62336,62580,63797,63919,64041,
    64284,64406,64650,64893,65137,65502,65624,65867,66111,66232,66354,66598,66719,66963,67206,67328,
    67450,67693,67937,68180,68424,68911,69154,69398,69641,69885,70128,70372,70859,71102,71346,71589,
    71833,72076,72320,72563,72807,72929,73050,73294,73537,73781,73903,74146,74268,74755,74998,75242,
    75485,75729,75972,76216,76703,76946,77190,77433,77799,78164,83277,83521,83643,83886,84008,84251,
    84617,84982,85225,85591,85956,86199,86565,87173,87539,87904,88634,89121,90826,91069,91435,91800,
    92043,92409,92774,93017,93383,93748,93991,94357,94965,95331,95696,95939,96305,96670,96913,97035,
    97157,98618,98861,99227,99592,99835,100201,100566,100809,101175,101540,101783,102027,102514,102757,103123,
    103488,103731,104097,104462,104705,106166,106410,106653,107140,107871,108114,108358,108601,109088,110306,110549,
    110915,111280,111523,111889,112254,112497,115906,116028,116150,116393,116515,116759,117002,117246,117611,117733,
    117976,118220,118341,118463,118707,118828,119072,119315,119437,119559,119802,120046,120289,120533,121020,121263,
    121507,121750,121994,122237,122359,122481,122968,123090,123211,123455,123698,123942,124185,124429,124672,124916,
    125159,125403,125646,125890,126012,126255,126377,126864,126986,127107,127351,127594,127838,127960,128081,128325,
    128812,129055,129299,129542,130029,130273,131490,131612,131734,131977,132099,132343,132586,132830,133195,133317,
    133560,133804,133925,134047,134291,134412,134656,134899,135021,135143,135386,135630,135873,136117,136604,136726,
    136847,137091,137334,137578,137821,138065,138552,138795,139039,139282,139526,139769,140013,140256,140500,140743,
    140987,141230,141474,141596,141839,141961,142448,142691,142935,143178,143665,143909,144396,144639,144883,145126,
    145492,145857,162658,163024,163145,163389,163632,163876,163998,164363,164485,164606,164850,165093,165337,167041,
    167407,167528,168015,168502,168746,169233,169720,170450,170572,170816,170937,171181,172398,172764,172885,173129,
    174833,175320,175564,176051,176294,176660,177025,177268,177634,180190,180312,180434,180677,180799,181043,181286,
    181530,181895,182017,182260,182382,182504,182625,182747,182991,183112,183356,183599,183721,183843,184086,184330,
    184573,184817,185182,185304,185547,185791,186034,186278,186521,186643,186765,187252,187495,187739,187982,188226,
    188469,188713,188956,189200,189443,189687,189930,190174,190296,190539,190661,191148,191270,191391,191635,191878,
    192122,192244,192365,192609,193096,193339,193583,193826,194313,194557,195774,195896,196018,196261,196383,196627,
    196870,197114,197479,197601,197844,198088,198209,198331,198575,198696,198940,199183,199305,199427,199670,199914,
    200157,200401,200888,201131,201375,201618,201862,202105,202349,202836,203079,203323,203566,203810,204053,204297,
    204540,204784,204906,205027,205271,205514,205758,205880,206123,206245,206732,206975,207219,207462,207706,207949,
    208193,208680,208923,209167,209410,209776,210141
    ];
    var melody_data1 = [
    'G#4','A#4','B4','C#5','D#5','D#5','D#5','F#5','E5','D#5','D#5','C#5','D#5','C#5','B4','C#5',
    'A#4','G#4','G#4','B4','C#5','D#5','F#5','E5','D#5','D#5','C#5','G#4','G#4','B4','D#5','C#5',
    'B4','A#4','B4','A#4','G#4','G#4','B4','B4','C#5','D#5','D#5','D#5','F#5','E5','D#5','D#5',
    'C#5','D#5','C#5','B4','C#5','A#4','G#4','B4','C#5','D#5','D#5','F#5','E5','D#5','D#5','C#5',
    'G#4','G#4','B4','D#5','C#5','B4','A#4','B4','A#4','G#4','C#5','D#5','D#5','D#5','D#5','D#5',
    'D#5','C#5','F#5','G#5','D#5','C#5','C#5','C#5','C#5','C#5','F#5','D#5','F#5','G#5','B4','A#4',
    'G#4','D#5','C#5','C#5','C#5','F#5','C#5','F#5','F#5','F#5','F#5','E5','D#5','C#5','G#4','G4',
    'G#4','G#4','A#4','C5','C#5','D#5','F5','D#5','D#5','D#5','D#5','D#5','F5','D#5','F5','F5',
    'F5','D#5','G4','G#4','G4','G#4','C#5','C#5','C5','A#4','G#4','D#5','G4','G4','G#4','G#4',
    'A#4','C5','C5','G#4','G#4','D#5','G#4','G#4','G#4','D#5','F5','D#5','C#5','D#5','D#5','D#5',
    'F5','G5','G#5','G#5','G#5','G#5','D#5','D#5','C#6','C6','A#5','A#5','G#5','G#4','G4','G#4',
    'G#4','A#4','C5','C#5','D#5','D#5','D#5','D#5','D#5','D#5','F5','D#5','F5','F5','F5','D#5',
    'G4','G#4','G4','G#4','C#5','C5','A#4','G#4','D#5','G4','G4','G#4','G#4','A#4','C5','C5',
    'G#4','G#4','G#4','D#5','G#4','G#4','G#4','G#4','D#5','F5','D#5','C#5','D#5','D#5','F5','G5',
    'G#5','G#5','G#5','D#5','D#5','C#6','C6','A#5','A#5','G#5','G#4','G#4','B4','B4','C#5','D#5',
    'D#5','D#5','F#5','E5','D#5','D#5','C#5','D#5','C#5','B4','C#5','A#4','G#4','G#4','B4','C#5',
    'D#5','D#5','D#5','F#5','E5','D#5','D#5','C#5','G#4','B4','D#5','C#5','B4','A#4','B4','A#4',
    'G#4','C#5','D#5','D#5','D#5','D#5','D#5','D#5','C#5','F#5','G#5','D#5','C#5','C#5','C#5','C#5',
    'C#5','F#5','D#5','F#5','G#5','B4','A#4','G#4','D#5','C#5','C#5','C#5','C#5','F#5','C#5','F#5',
    'F#5','F#5','F#5','E5','D#5','C#5','G#4','G4','G#4','G#4','A#4','C5','C#5','D#5','D#5','D#5',
    'D#5','D#5','D#5','F5','D#5','F5','F5','F5','D#5','G4','G#4','G4','G#4','C#5','C5','A#4',
    'G#4','D#5','G4','G4','G4','G#4','G#4','G#4','A#4','C5','C5','G#4','G#4','G#4','D#5','G#4',
    'G#4','G#4','D#5','F5','D#5','C#5','D#5','D#5','D#5','F5','G5','G#5','G#5','G#5','G#5','D#5',
    'D#5','C#6','C6','A#5','A#5','G#5','G#4','G4','G#4','G#4','A#4','C5','C#5','D#5','D#5','D#5',
    'D#5','D#5','D#5','F5','D#5','F5','F5','F5','D#5','G4','G#4','G4','G#4','C#5','C5','C5',
    'A#4','G#4','D#5','G4','G4','G#4','G#4','A#4','C5','C5','G#4','G#4','G#4','D#5','G#4','G#4',
    'G#4','D#5','F5','D#5','C#5','D#5','D#5','F5','G5','G#5','G#5','D#5','D#5','C#6','C6','A#5',
    'A#5','G#5','G#5','G5','D#5','C5','C#5','D#5','D#5','D#5','D#5','A#5','G#5','G5','G#5','G#5',
    'G#5','G5','A#5','C6','A#5','G#5','G5','F5','F5','F5','F5','C6','G#5','G#5','A#5','G#5',
    'C#5','C#5','G#5','G#5','G5','G#5','A#5','C6','A#5','G#4','G4','G#4','G#4','A#4','C5','C#5',
    'D#5','F5','D#5','D#5','D#5','D#5','D#5','F5','D#5','F5','F5','F5','D#5','G4','G#4','G4',
    'G#4','C#5','C#5','C5','A#4','G#4','D#5','G4','G4','G4','G#4','G#4','A#4','C5','C5','G#4',
    'G#4','G#4','D#5','G#4','G#4','G#4','D#5','F5','D#5','C#5','D#5','D#5','D#5','F5','G5','G#5',
    'G#5','G#5','G#5','D#5','D#5','C#6','C6','A#5','A#5','G#5','G#4','G4','G#4','G#4','A#4','C5',
    'C#5','D#5','D#5','D#5','D#5','D#5','D#5','F5','D#5','F5','F5','F5','D#5','G4','G#4','G4',
    'G#4','C#5','C5','A#4','G#4','D#5','G4','G4','G#4','G#4','A#4','C5','C5','G#4','G#4','G#4',
    'D#5','G#4','G#4','G#4','G#4','D#5','F5','D#5','C#5','D#5','D#5','F5','G5','G#5','G#5','G#5',
    'D#5','D#5','C#6','C6','A#5','A#5','G#5'
    ];
    var melody_volume_ary1 = [
    100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,
    100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,
    100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,
    100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,
    100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,
    100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,
    100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,
    100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,
    100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,
    100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,
    100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,
    100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,
    100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,
    100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,
    100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,
    100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,
    100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,
    100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,
    100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,
    100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,
    100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,
    100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,
    100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,
    100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,
    100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,
    100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,
    100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,
    100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,
    100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,
    100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,
    100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,
    100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,
    100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,
    100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,
    100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,
    100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,
    100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,
    100,100,100,100,100,100,100
    ];
    
    
    var timeScale = 1.5;
    for(var i=0; i<melody_time_ary1.length; i++){
        melody_time_ary1[i] = melody_time_ary1[i] + 5150;
        //melody_time_ary1[i] = melody_time_ary1[i];
    }

    

var melody_length_ary = melody_length_ary1;
var melody_time_ary = melody_time_ary1;
var melody_data = melody_data1;
var melodyFlagAry = createBrankAry(melody_time_ary);

var countUp = 0;
var atCount = 0;
var startTime = new Date(), atTime = new Date(), diffTime = new Date();

var beforeX = 0, beforeY = 0;
var norm_threshold = -1;
var beforeRange = 100;
var afterRange = 100;

document.addEventListener("DOMContentLoaded", function(){
    var ripple_wood = document.getElementById("ripple_div");
    
    ripple_wood.addEventListener("mousedown", function (event) { 

        var norm = Math.sqrt( Math.pow(event.pageX - beforeX,2) + Math.pow(event.pageY - beforeY, 2));
        //console.log(norm);
        beforeX = event.pageX;
        beforeY = event.pageY;

        var synth = new Tone.Synth().toMaster();
        //synth.volume.value = 1;
        if(count == 0){
            //startAccompaniment(accompaniment_time_ary, accompaniment_data);
           // startAccompaniment(melody_time_ary1, melody_data1, melody_length_ary1, melody_volume_ary1, melodyFlagAry, false);
            startAccompaniment(melody_time_ary1, melody_data1, melody_length_ary1, melody_volume_ary1, melodyFlagAry, true);
/*            startAccompaniment(melody_time_ary2, melody_data2, melody_length_ary2, melody_volume_ary2, melodyFlagAry, false);
            startAccompaniment(melody_time_ary3, melody_data3, melody_length_ary3, melody_volume_ary3, melodyFlagAry, false);
            startAccompaniment(melody_time_ary4, melody_data4, melody_length_ary4, melody_volume_ary4, melodyFlagAry, false);
            startAccompaniment(melody_time_ary5, melody_data5, melody_length_ary5, melody_volume_ary5, melodyFlagAry, false);
            startAccompaniment(melody_time_ary6, melody_data6, melody_length_ary6, melody_volume_ary6, melodyFlagAry, false);
            startAccompaniment(melody_time_ary7, melody_data7, melody_length_ary7, melody_volume_ary7, melodyFlagAry, false);
            startAccompaniment(melody_time_ary8, melody_data8, melody_length_ary8, melody_volume_ary8, melodyFlagAry, false);
            startAccompaniment(melody_time_ary9, melody_data9, melody_length_ary9, melody_volume_ary9, melodyFlagAry, false);
            startAccompaniment(melody_time_ary10, melody_data10, melody_length_ary10, melody_volume_ary10, melodyFlagAry, false);
            startAccompaniment(melody_time_ary11, melody_data11, melody_length_ary11, melody_volume_ary11, melodyFlagAry, false);
            startAccompaniment(melody_time_ary12, melody_data12, melody_length_ary12, melody_volume_ary12, melodyFlagAry, false);
            startAccompaniment(melody_time_ary13, melody_data13, melody_length_ary13, melody_volume_ary13, melodyFlagAry, false);
            startAccompaniment(melody_time_ary14, melody_data14, melody_length_ary14, melody_volume_ary14, melodyFlagAry, false);
            startAccompaniment(melody_time_ary15, melody_data15, melody_length_ary15, melody_volume_ary15, melodyFlagAry, false);
            startAccompaniment(melody_time_ary16, melody_data16, melody_length_ary16, melody_volume_ary16, melodyFlagAry, false);
*/
            Tone.Transport.start();
            startTime = new Date();
            atTime = new Date();
            countUp = 0;
            atCount = 0;
            new Audio('MP3/silentMajority.mp3').play();  
        }else{
            atTime = new Date();
        }
        diffTime = atTime.getTime() - startTime.getTime();
        //console.log(diffTime);
        
        var clickSuccessFlag = false;
        for(var i=atCount; i<melody_time_ary.length; i++){
           // music_scale = melody_data[countUp];
           // console.log(melody_time_ary[i] * BPNConvertMSEC);
            //if((melody_time_ary[i] - beforeRange) <= diffTime + melody_time_ary[0] && (melody_time_ary[i] + afterRange) >= diffTime + melody_time_ary[0] ){
            if((melody_time_ary[i] - beforeRange) <= diffTime && (melody_time_ary[i] + afterRange) >= diffTime){
                atCount = i;
                clickSuccessFlag = true;
                console.log("Success!" + atCount);
                break;
            }
        }

        var rand = Math.round(Math.random() * melody_data.length);
        
        if(clickSuccessFlag){
            for(var i=atCount; i<atCount+10; i++){
                if(melody_time_ary[atCount] == melody_time_ary[i]){
                    //if(melodyFlagAry[i] == 0){
                        if(norm > norm_threshold){
                            console.log("OK!");
                            music_scale = melody_data[i];
                            music_length = melody_length_ary[i];
                            melodyFlagAry[i] = 1;
                        }else{
                            music_scale = music_scale;
                            music_length = music_length;
                            console.log("Same Miss!");
                        }
/*
                   // }else{
                        if(norm > norm_threshold){
                            console.log("Miss1!");
                            music_scale = melody_data[rand];
                        }
                        //music_scale = 0;
                }*/
                    synth.triggerAttackRelease(music_scale, melody_length_ary[i]);
                }
            }
        }else{
            if(norm > norm_threshold){
                console.log("Miss2!");
                music_scale = melody_data[rand];
            }else{
                console.log("Miss3!");
            }
            synth.triggerAttackRelease(music_scale, "8n");
        }
 
        //music_scale = melody_data[countUp];
        countUp++;
        

        if((melody_time_ary[melody_time_ary.length-1]) < diffTime){
            //Tone.Transport.stop();
            console.log("Over!");
            count = 0;
            melodyFlagAry = createBrankAry(melody_time_ary);
        }
        else{
            count++;
        }
    }, false);

}, false);

function waitNote(msec, count, mainFlag, flagAry){
    var objDef = new $.Deferred;
    setTimeout(function(){
        objDef.resolve(count, mainFlag, flagAry);
    }, msec);
    return objDef.promise(count, mainFlag, flagAry);
}

function startAccompaniment(timeAry, dataAry, lengthAry, volumeAry, flagAry, mainFlag){
    var synth = new Tone.Synth().toMaster();
    for(var i=0; i<timeAry.length; i++){
        //var nextTime = timeAry[i] - melody_time_ary[0];
        var nextTime = timeAry[i];
        //nextTime = nextTime * 2.5;

        waitNote(nextTime, i, mainFlag, flagAry).done(function(count, mainFlag){
            if(mainFlag){
                if(flagAry[count] == 0){
                    synth.volume.value = -0.1*(255 - volumeAry[count]);
                    synth.volume.value = -20;
                    var scale = dataAry[count];
                    synth.triggerAttackRelease(scale, lengthAry[count]);
                }
            }
            else{
                synth.volume.value = -0.1*(255 - volumeAry[count])/2;
                var scale = dataAry[count];
                synth.triggerAttackRelease(scale, lengthAry[count]); 
            }
        });
    }
}

function createBrankAry(ary){
    var tempAry = {};
    for(var i=0; i<ary.length; i++){
        tempAry[i] = 0;
    }
    return tempAry;
}

