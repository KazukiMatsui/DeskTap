var music_scale;
var ToneBPM = 200;
var BPNConvertMSEC = 60 / ToneBPM * 1000;
Tone.Transport.bpm.value = ToneBPM;
console.log(BPNConvertMSEC);

var count = 0;
/*
var melody_length_ary1 = [
    0.182291666666667,0.172916666666667,0.195833333333333,0.189583333333333,0.2,0.161979166666667,0.172916666666667,0.190104166666667,0.352083333333333,0.182291666666667,0.1609375,0.208854166666667,0.31875,0.1859375,0.190104166666667,0.189583333333333,
    0.347395833333333,0.141666666666667,0.175,0.178645833333333,0.179166666666667,0.184375,0.180729166666667,0.182291666666667,0.172916666666667,0.1953125,0.344791666666667,0.1671875,0.172916666666667,0.191666666666667,0.328645833333333,0.184375,
    0.165625,0.179166666666667,0.578645833333333,0.1453125,0.178645833333333,0.188541666666667,0.168229166666667,0.197395833333333,0.178645833333333,0.169270833333333,0.1859375,0.3453125,0.190104166666667,0.160416666666667,0.1953125,0.335416666666667,
    0.178645833333333,0.202083333333333,0.189583333333333,0.335416666666667,0.138541666666667,0.172916666666667,0.178645833333333,0.175,0.2015625,0.2203125,0.183333333333333,0.161979166666667,0.202604166666667,0.3375,0.15625,0.168229166666667,
    0.184895833333333,0.321354166666667,0.190625,0.178645833333333,0.178645833333333,0.4140625,0.205729166666667,0.201041666666667,0.195833333333333,0.375,0.171875,0.199479166666667,0.188020833333333,0.352083333333333,0.172916666666667,0.207291666666667,
    0.2125,0.324479166666667,0.189583333333333,0.211979166666667,0.21875,0.36875,0.0744791666666667,0.1515625,0.279166666666667,0.100520833333333,0.1625,0.279166666666667,0.2015625,0.1609375,0.245833333333333,0.1953125,
    0.178645833333333,0.1625,0.168229166666667,0.190625,0.179166666666667,0.172916666666667,0.1859375,0.211979166666667,0.160416666666667,0.161979166666667,0.205729166666667,0.31875,0.172916666666667,0.178645833333333,0.1828125,0.341145833333333,
    0.184895833333333,0.190625,0.2015625,0.314583333333333,0.1359375,0.172916666666667,0.168229166666667,0.178645833333333,0.178645833333333,0.199479166666667,0.1828125,0.179166666666667,0.184375,0.334375,0.1953125,0.160416666666667,
    0.191666666666667,0.3390625,0.1671875,0.179166666666667,0.229166666666667,2.03802083333333,2.025
];
var melody_time_ary1 = [
    3330,3663,3996,4329,4662,4995,5328,5661,5994,6993,7326,7659,7992,8991,9324,9657,
    9990,10989,11322,11655,11988,12321,12654,12987,13320,13653,13986,14985,15318,15651,15984,16983,
    17316,17649,17982,19314,19647,19980,20313,20646,20979,21312,21645,21978,22977,23310,23643,23976,
    24975,25308,25641,25974,26973,27306,27639,27972,28305,28638,28971,29304,29637,29970,30969,31302,
    31635,31968,32967,33300,33633,33966,34965,35298,35631,35964,36963,37296,37629,37962,38961,39294,
    39627,39960,40959,41292,41625,41958,42624,42957,43290,43956,44289,44622,44955,45288,45621,45954,
    46287,46620,46953,47286,47619,47952,48285,48618,48951,49284,49617,49950,50949,51282,51615,51948,
    52947,53280,53613,53946,54945,55278,55611,55944,56277,56610,56943,57276,57609,57942,58941,59274,
    59607,59940,60939,61272,61605,61938,61938
];
var melody_data1 = [
    'E5','D#5','E5','D#5','E5','B4','D5','C5','A4','C4','E4','A4','B4','E4','G#4','B4',
    'C5','E4','E5','D#5','E5','D#5','E5','B4','D5','C5','A4','C4','E4','A4','B4','E4',
    'C5','B4','A4','E5','D#5','E5','D#5','E5','B4','D5','C5','A4','C4','E4','A4','B4',
    'E4','G#4','B4','C5','E4','E5','D#5','E5','D#5','E5','B4','D5','C5','A4','C4','E4',
    'A4','B4','E4','C5','B4','A4','B4','C5','D5','E5','G4','F5','E5','D5','F4','E5',
    'D5','C5','E4','D5','C5','B4','E4','E4','E5','E5','E5','E6','D#5','E5','D#5','E5',
    'D#5','E5','D#5','E5','D#5','E5','D#5','E5','B4','D5','C5','A4','C4','E4','A4','B4',
    'E4','G#4','B4','C5','E4','E5','D#5','E5','D#5','E5','B4','D5','C5','A4','C4','E4',
    'A4','B4','D4','C5','B4','A4','C4'
];
var melody_length_ary2 = [
    0.369791666666667,0.643229166666667,0.370833333333333,0.669791666666667,0.341145833333333,0.659895833333333,0.328645833333333,0.6640625,0.353125,0.667708333333333,0.656770833333333,0.385416666666667,0.659895833333333,0.375,0.671875,0.335416666666667,
    0.660416666666667,0.3359375,0.665625,0.352083333333333,0.688020833333333,0.698958333333333,0.172916666666667,0.717708333333333,0.175,0.772395833333333,0.177083333333333,0.689583333333333,1.034375,1.07291666666667,0.351041666666667,0.653125,
    0.367708333333333,0.665625,0.3296875,0.647395833333333,0.3453125,0.666145833333333,0.36875,0.408333333333333,2.03802083333333,2.025
];
var melody_time_ary2 = [
    5999,6666,7998,8665,9997,10664,13994,14661,
    15993,16660,17992,21989,22656,23988,24655,25987,
    26654,29984,30651,31983,32650,33982,36314,36647,
    38312,38645,40310,40643,41975,41975,49969,50636,
    51968,52635,53967,54634,57964,58631,59963,60630,
    61962,61962
];
var melody_data2 = [
    'A3','E3','G#3','E3','A3','E3','A3','E3','G#3','E3','A3','A3','E3','G#3','E3','A3',
    'E3','A3','E3','G#3','E3','A3','G3','C4','G3','B3','A3','C4','E3','G#3','A3','E3',
    'G#3','E3','A3','E3','A3','E3','G#3','E3','A2','E3'
];
*/

//channel:1

//channel:1
var melody_length_ary1 = [
    1.33697916666667,1.33697916666667,1.325,1.34322916666667,1.35989583333333,0.266666666666667,1.3515625,0.247916666666667,0.25625,0.254166666666667,0.264583333333333,0.2078125,0.271354166666667,0.2828125,0.175520833333333,0.177604166666667,
    0.220833333333333,0.1875,0.147395833333333,0.158333333333333,0.154166666666667,0.19375,0.274479166666667,0.264583333333333,0.25625,0.30625,1.33072916666667,0.255729166666667,0.199479166666667,0.2265625,0.214583333333333,0.172916666666667,
    0.23125,0.3046875,0.228645833333333,0.1,0.106770833333333,0.121354166666667,0.123958333333333,1.31614583333333,0.3125,0.314583333333333,0.29375,0.302083333333333,0.210416666666667,0.238020833333333,0.2078125,0.224479166666667,
    0.16875,0.166145833333333,0.1671875,0.1703125,0.158333333333333,0.113020833333333,0.15,0.144270833333333,0.271354166666667,0.202083333333333,1.2640625,0.1953125,0.203645833333333,0.202083333333333,0.149479166666667,0.161979166666667,
    0.158854166666667,0.2375,0.172395833333333,0.181770833333333,0.166666666666667,0.105729166666667,0.0583333333333333,0.0833333333333333,0.0833333333333333,0.26875,0.0901041666666667,0.0875,0.0625,0.104166666666667,0.108333333333333,0.0973958333333333,
    1.01354166666667,0.0833333333333333,0.0729166666666667,0.0921875,0.08125,0.0828125,0.0807291666666667,0.0526041666666667,0.0848958333333333,0.0765625,0.1046875,0.147395833333333,0.0734375,1.40885416666667,0.1046875,0.102083333333333,
    0.100520833333333,0.0979166666666667,0.119270833333333,0.1109375,0.105729166666667,0.1,0.0833333333333333,0.1203125,0.0994791666666667,0.1078125,0.109895833333333,0.152083333333333,0.0713541666666667,1.68854166666667,0.1125,0.122395833333333,
    0.1015625,0.1296875,0.0869791666666667,0.102083333333333,0.0791666666666667,0.0583333333333333,0.0458333333333333,0.0807291666666667,0.125520833333333,0.133854166666667,0.133854166666667,0.125520833333333,0.165104166666667,0.1984375,0.1375,0.1390625,
    0.0432291666666667,0.0734375,0.0932291666666667,0.075,0.169791666666667,0.0583333333333333,0.225,0.102083333333333,0.107291666666667,0.0666666666666667,0.0723958333333333,0.075,0.0651041666666667,0.972916666666667,0.0770833333333333,0.0838541666666667,
    0.0755208333333333,0.0734375,0.0583333333333333,0.0723958333333333,0.0932291666666667,0.0708333333333333,0.114583333333333,0.1359375,0.0640625,0.885416666666667,0.0666666666666667,0.0875,0.0854166666666667,0.0713541666666667,0.0723958333333333,0.0770833333333333,
    0.0765625,0.05625,0.05,0.0625,0.0859375,0.0651041666666667,0.115104166666667,0.0708333333333333,0.0541666666666667,0.204166666666667,2.1609375,2.20104166666667,0.0947916666666667,0.104166666666667,0.0890625,0.0833333333333333,
    0.1,0.0875,0.0859375,0.0890625,0.04375,0.0744791666666667,0.0619791666666667,0.0536458333333333,0.0734375,0.09375,0.0723958333333333,0.0848958333333333,0.0776041666666667,0.0770833333333333,0.11875,0.0770833333333333,
    0.075,0.0442708333333333,0.0625,0.0723958333333333,0.0817708333333333,0.0625,0.272916666666667,0.105729166666667,0.104166666666667,0.0880208333333333,0.0770833333333333,0.9625,0.0755208333333333,0.0630208333333333,0.0723958333333333,0.0708333333333333,
    0.0666666666666667,0.0708333333333333,0.05,0.0625,0.0640625,0.0791666666666667,0.0984375,0.1328125,0.0651041666666667,1.39739583333333,0.0692708333333333,0.0692708333333333,0.0625,0.0692708333333333,0.0776041666666667,0.0807291666666667,
    0.0807291666666667,0.075,0.1078125,0.0588541666666667,0.0755208333333333,0.0854166666666667,0.1140625,0.164583333333333,0.0666666666666667,2.821875,0.0921875,0.0958333333333333,0.0958333333333333,0.0838541666666667,0.122916666666667,0.0901041666666667,
    0.0833333333333333,0.0625,0.0526041666666667,0.0916666666666667,0.0708333333333333,0.0515625,0.0848958333333333,0.0984375,0.133333333333333,0.0916666666666667,0.0791666666666667,0.0932291666666667,0.0833333333333333,0.106770833333333,0.0625,0.0375,
    0.0520833333333333,0.0630208333333333,0.0401041666666667,0.250520833333333,0.0598958333333333,0.3296875,0.105729166666667,0.108333333333333,0.0583333333333333,0.0546875,0.0567708333333333,0.0708333333333333,0.977083333333333,0.0776041666666667,0.0526041666666667,0.0692708333333333,
    0.0625,0.0515625,0.0666666666666667,0.0875,0.0692708333333333,0.0979166666666667,0.133333333333333,0.0708333333333333,0.901041666666667,0.075,0.0807291666666667,0.0708333333333333,0.0692708333333333,0.0666666666666667,0.0791666666666667,0.0697916666666667,
    0.0708333333333333,0.05,0.0807291666666667,0.0567708333333333,0.0692708333333333,0.119270833333333,0.0666666666666667,0.0625,0.260416666666667,1.96145833333333,1.9125,0.0901041666666667,0.0942708333333333,0.123958333333333,0.0791666666666667,0.0859375,
    0.0859375,0.0770833333333333,0.0916666666666667,0.05,0.0796875,0.0630208333333333,0.0958333333333333,0.0916666666666667,0.0765625,0.0916666666666667,0.0833333333333333,0.0869791666666667,0.0625,0.08125,0.0755208333333333,0.1015625,
    0.125520833333333,0.0942708333333333,0.0807291666666667,0.0916666666666667,0.120833333333333,0.1859375,0.0666666666666667,0.2296875,0.1,0.104166666666667,0.0682291666666667,0.0619791666666667,0.0515625,0.0541666666666667,0.861979166666667,0.0723958333333333,
    0.0708333333333333,0.0666666666666667,0.0916666666666667,0.0515625,0.0614583333333333,0.0807291666666667,0.0708333333333333,0.0916666666666667,0.143229166666667,0.0723958333333333,0.9875,0.08125,0.102083333333333,0.0817708333333333,0.0692708333333333,0.075,
    0.0817708333333333,0.0723958333333333,0.0765625,0.0557291666666667,0.0791666666666667,0.0598958333333333,0.0734375,0.118229166666667,0.163020833333333,0.0604166666666667,0.3078125,0.0609375,2.16770833333333,0.0609375,0.0583333333333333,0.0625,
    0.05,0.0666666666666667,0.0567708333333333,0.075,0.05625,0.075,0.04375,0.0567708333333333,0.075,0.0708333333333333,0.0838541666666667,0.08125,0.0744791666666667,0.0796875,0.0708333333333333,0.0567708333333333,
    0.0791666666666667,0.0609375,0.0432291666666667,0.0515625,0.0666666666666667,0.0640625,0.228645833333333,0.0604166666666667,0.208854166666667,0.0979166666666667,0.114583333333333,0.106770833333333,0.05,0.0458333333333333,0.0848958333333333,0.897916666666667,
    0.1,0.0703125,0.0765625,0.0791666666666667,0.0375,0.0734375,0.0541666666666667,0.0609375,0.108333333333333,0.134895833333333,0.0682291666666667,1.2,0.1,0.0875,0.0942708333333333,0.0848958333333333,
    0.0755208333333333,0.0645833333333333,0.0713541666666667,0.0901041666666667,0.0848958333333333,0.120833333333333,0.0958333333333333,0.111458333333333,0.13125,0.1390625,2.975,0.0817708333333333,0.0994791666666667,0.1046875,0.0921875,0.1,
    0.102604166666667,0.0932291666666667,0.0541666666666667,0.0765625,0.0640625,0.0916666666666667,0.09375,0.0958333333333333,0.0791666666666667,0.0666666666666667,0.0833333333333333,0.0833333333333333,0.0588541666666667,0.08125,0.0921875,0.0807291666666667,
    0.252083333333333,0.0640625,0.0541666666666667,0.352083333333333,0.08125,0.0770833333333333,0.0734375,0.075,0.0583333333333333,0.0666666666666667,0.115104166666667,0.139583333333333,0.108333333333333,0.0598958333333333,0.0416666666666667,0.0666666666666667,
    0.205729166666667,0.1171875,0.1515625,0.0880208333333333,0.228645833333333,0.0984375,0.131770833333333,0.4890625,0.0765625,0.0708333333333333,0.0619791666666667,0.0791666666666667,0.0625,0.0682291666666667,0.0807291666666667,0.0640625,
    0.0828125,0.133333333333333,0.128645833333333,0.153125,0.0723958333333333,2.08645833333333,0.0932291666666667,0.0973958333333333,0.102604166666667,0.10625,0.0895833333333333,0.0921875,0.0682291666666667,0.0791666666666667,0.0541666666666667,0.0723958333333333,
    0.08125,0.0833333333333333,0.0770833333333333,0.0916666666666667,0.0833333333333333,0.0692708333333333,0.0890625,0.075,0.0583333333333333,0.0604166666666667,0.234895833333333,0.104166666666667,0.0989583333333333,0.386979166666667,0.075,0.0609375,
    0.0625,0.0755208333333333,0.0729166666666667,0.0541666666666667,0.109895833333333,0.133333333333333,0.114583333333333,0.0640625,0.0520833333333333,0.0666666666666667,0.2125,0.122916666666667,0.131770833333333,0.0708333333333333,0.29375,0.1015625,
    0.104166666666667,0.0713541666666667,0.0645833333333333,0.530729166666667,0.06875,0.0848958333333333,0.0817708333333333,0.0609375,0.0666666666666667,0.0791666666666667,0.0875,0.124479166666667,0.105729166666667,0.1390625,0.0729166666666667,2.79739583333333,
    0.1015625,0.107291666666667,0.1,0.0833333333333333,0.0838541666666667,0.0734375,0.0875,0.0583333333333333,0.0692708333333333,0.0833333333333333,0.0979166666666667,0.119791666666667,0.108854166666667,0.104166666666667,0.103125,0.0916666666666667,
    0.0609375,0.0848958333333333,0.0666666666666667,0.0791666666666667,0.275,0.0875,0.0625,0.0833333333333333,0.0833333333333333,0.0807291666666667,0.075,0.958854166666667,0.05625,0.0833333333333333,0.0791666666666667,0.075,
    0.0484375,0.0651041666666667,0.0666666666666667,0.0833333333333333,0.10625,0.158333333333333,0.075,1.31458333333333,0.0770833333333333,0.08125,0.0817708333333333,0.0833333333333333,0.0682291666666667,0.0807291666666667,0.0776041666666667,0.0682291666666667,
    0.05,0.0776041666666667,0.0625,0.0682291666666667,0.104166666666667,0.153645833333333,0.0651041666666667,1.74270833333333,0.0973958333333333,0.1015625,0.0958333333333333,0.0921875,0.0770833333333333,0.075,0.0541666666666667,0.0708333333333333,
    0.0432291666666667,0.0994791666666667,0.135416666666667,0.127083333333333,0.131770833333333,0.131770833333333,0.140625,0.15,0.133333333333333,0.134895833333333,0.0291666666666667,0.0541666666666667,0.0541666666666667,0.05,0.235416666666667,0.0640625,
    0.272916666666667,0.108333333333333,0.115625,0.0630208333333333,0.06875,0.0666666666666667,0.0583333333333333,1.03333333333333,0.0703125,0.0541666666666667,0.0916666666666667,0.0703125,0.0567708333333333,0.075,0.0973958333333333,0.075,
    0.102604166666667,0.15625,0.0854166666666667,1.2015625,0.0807291666666667,0.0833333333333333,0.0817708333333333,0.0765625,0.0734375,0.0942708333333333,0.0833333333333333,0.0833333333333333,0.0505208333333333,0.0770833333333333,0.09375,0.0854166666666667,
    0.119270833333333,0.0645833333333333,0.0583333333333333,0.2203125,2.63125,2.65364583333333,0.102604166666667,0.0963541666666667,0.1171875,0.0901041666666667,0.132291666666667,0.0932291666666667,0.0947916666666667,0.0848958333333333,0.0375,0.075,
    0.0541666666666667,0.05,0.08125,0.134895833333333,0.0958333333333333,0.0833333333333333,0.0973958333333333,0.146354166666667,0.0901041666666667,0.0776041666666667,0.0817708333333333,0.1015625,0.0479166666666667,0.0640625,0.0520833333333333,1.32239583333333,
    0.197916666666667,0.221354166666667,0.247916666666667,0.216145833333333,0.227083333333333,0.183333333333333,0.197916666666667,0.239583333333333,0.197395833333333,0.1890625,0.180729166666667,0.180729166666667,0.133854166666667,0.16875,0.177083333333333,0.164583333333333,
    0.199479166666667,0.227083333333333,0.213020833333333,0.225520833333333,1.3328125,0.191666666666667,0.184895833333333,0.191145833333333,0.186979166666667,0.214583333333333,0.21875,0.274479166666667,0.24375,0.102083333333333,0.129166666666667,0.134895833333333,
    0.125,0.3203125,0.285416666666667,0.29375,1.32083333333333,0.274479166666667,0.211458333333333,0.202083333333333,0.200520833333333,0.1921875,0.186979166666667,0.191666666666667,0.159895833333333,0.169791666666667,0.160416666666667,0.158854166666667,
    0.119270833333333,0.154166666666667,1.33958333333333,0.2578125,0.208854166666667,0.202083333333333,0.202083333333333,0.235416666666667,0.224479166666667,0.25625,0.2328125,0.253125,0.197916666666667,0.189583333333333,0.185416666666667,0.122916666666667,
    0.184895833333333,0.145833333333333,0.1390625,0.25625,0.250520833333333,0.266145833333333,1.34322916666667,0.208333333333333,0.227083333333333,0.189583333333333,0.183854166666667,0.188020833333333,0.193229166666667,0.165625,0.179166666666667,0.1765625,
    0.177604166666667,0.164583333333333,0.133333333333333,0.154166666666667,1.31822916666667,0.216145833333333,0.21875,0.185416666666667,0.23125,0.193229166666667,0.186458333333333,0.193229166666667,0.227083333333333,0.2078125,0.2171875,0.210416666666667,
    0.221354166666667,0.1390625,0.10625,0.13125,0.128645833333333,0.233854166666667,0.239583333333333,1.365625,0.227083333333333,0.222916666666667,0.199479166666667,0.1953125,0.197916666666667,0.19375,0.183333333333333,0.193229166666667,
    0.168229166666667,0.204166666666667,0.171354166666667,0.169270833333333,0.175,0.1609375,0.21875,1.42239583333333,0.2,0.191145833333333,0.197916666666667,0.23125,0.185416666666667,0.18125,0.172395833333333,0.21875,
    0.1796875,0.182291666666667,0.171354166666667,0.179166666666667,0.1765625,0.168229166666667,0.168229166666667,2.365625,2.35416666666667,2.35572916666667,2.36145833333333,2.35989583333333
    ];
    var melody_time_ary1 = [
    0,8,11,16,16,3295,3307,3307,3307,3307,4122,4135,4138,4143,4950,4954,
    4954,4954,5739,5742,5742,5758,6522,6533,6533,6533,6546,7322,7334,7338,7342,8105,
    8110,8113,8126,8901,8904,8912,8920,9745,9753,9757,9761,9761,10553,10556,10561,10569,
    11293,11293,11296,11301,12064,12068,12077,12080,12868,12868,12868,12873,12873,13675,13680,13680,
    13691,14424,14440,14443,14451,15228,15231,15236,15239,16075,16079,16655,16803,16998,17003,17003,
    17003,17014,17815,17818,17823,17831,18591,18594,18599,18599,18973,19158,19417,19433,20181,20194,
    20202,20202,20981,20989,20994,21002,21777,21782,21790,21790,22186,22389,22669,22689,23448,23453,
    23461,24260,24265,24268,25020,25025,25028,25816,26599,26604,26612,26615,27399,27407,27407,27412,
    28208,28211,28216,28216,28636,29067,29083,29611,29780,29951,29951,29954,29954,29970,30747,30750,
    30750,30750,31494,31507,31515,31518,31886,32074,32295,32330,33070,33070,33070,33073,33854,33858,
    33870,33874,34618,34634,34637,34645,35033,35233,35469,35477,36262,36262,36262,36265,36270,36273,
    37085,37085,37088,37093,37868,37873,37873,37881,38644,39424,39424,39432,39435,40212,40220,40224,
    40224,40975,40983,40988,40991,41744,41747,42324,42471,42647,42655,42655,42663,42671,43431,43439,
    43447,43450,44174,44187,44195,44195,44554,44727,44974,44990,45706,45722,45722,45722,46481,46486,
    46494,46494,47274,47285,47285,47285,47686,47881,48162,48181,48924,48929,48937,48940,49693,49697,
    49705,49713,50464,50469,50477,50485,51273,52068,52084,52092,52092,52869,52880,52883,52888,53660,
    53668,53671,53671,54051,54500,54535,55104,55267,55419,55422,55422,55427,55447,56211,56219,56219,
    56219,56935,56946,56954,56954,57343,57502,57742,57755,58518,58523,58534,58534,59266,59282,59287,
    59290,60022,60030,60033,60033,60389,60586,60830,60850,61637,61645,61645,61645,61650,61650,62420,
    62436,62441,62441,63201,63205,63205,63209,63989,64785,64788,64796,64801,65580,65592,65592,65601,
    65996,66459,66464,66472,66472,66943,67443,67475,68047,68215,68364,68372,68372,68383,68399,69148,
    69159,69164,69167,69856,69864,69867,69878,70247,70391,70639,70658,71422,71438,71442,71442,72179,
    72190,72195,72203,72954,72970,72970,72973,73374,73561,73798,73842,74441,74662,74673,74673,74681,
    74686,75413,75416,75421,75429,76173,76177,76181,76189,76961,77744,77749,77757,77760,78520,78528,
    78528,78544,79289,79292,79300,79308,79676,80136,80163,80703,80860,81011,81019,81032,81032,81056,
    81831,81836,81836,81847,82571,82575,82575,82583,82959,83131,83368,83390,84122,84143,84146,84151,
    84894,84910,84910,84914,85635,85646,85651,85659,86014,86239,86517,86525,87254,87257,87257,88025,
    88025,88030,88773,88781,88786,89561,90333,90337,90345,91109,91112,91112,91879,91884,91887,92753,
    92788,93336,93427,93651,93656,93664,93667,94392,94403,94408,94571,94763,94943,95140,95151,95156,
    95156,95527,95696,95966,95995,96449,96583,96791,96795,96803,96807,97570,97578,97583,98315,98315,
    98331,98527,98735,98925,99227,99227,99978,99986,99989,100745,100753,100753,101518,101526,101526,102325,
    103097,103105,103105,103873,103881,103884,104677,104680,104685,105524,105536,106092,106241,106396,106407,106415,
    106423,107131,107144,107147,107308,107492,107676,107904,107908,107915,107920,108315,108479,108708,108740,109275,
    109411,109582,109587,109587,109591,110363,110374,110374,111114,111119,111127,111343,111547,111739,111990,112014,
    112774,112787,112790,113573,113581,113581,114378,114381,114381,115209,116005,116008,116016,116821,116826,116829,
    117604,117617,117620,118460,118496,119064,119224,119379,119384,119384,119400,119419,120172,120180,120188,120188,
    120959,120967,120980,120980,121383,121547,121835,121859,122575,122583,122587,122587,123367,123375,123378,123383,
    124126,124142,124142,124147,124559,124743,125014,125027,125842,125855,125858,126654,126654,126658,127401,127406,
    127414,128186,128969,128977,128981,128981,129766,129769,129769,129774,130600,130600,130605,130605,131017,131493,
    131504,132084,132265,132423,132428,132428,132436,132463,133248,133252,133260,133264,134003,134016,134024,134027,
    134431,134575,134839,134871,135628,135636,135639,135644,136414,136422,136430,136430,137194,137199,137207,137207,
    137614,137819,138063,138079,138897,138902,138913,138921,138929,138929,139739,139739,139739,139739,140533,140538,
    140541,140541,141361,142177,142177,142182,142182,143013,143016,143016,143024,143797,143809,143813,143817,144612,
    144620,144620,144620,144633,145440,145452,145456,145456,146253,146261,146269,146269,147023,147036,147036,147039,
    147848,147851,147851,147851,147851,148635,148640,148640,148640,149391,149399,149399,149407,150195,150199,150199,
    150207,150995,150995,150998,150998,151003,151853,151858,151866,151866,152638,152642,152650,152655,153446,153449,
    153449,153454,154261,154274,154277,154285,154285,155077,155082,155082,155082,155852,155857,155865,155865,156645,
    156649,156649,156657,157440,157448,157453,157456,157456,158297,158300,158300,158316,159116,159121,159124,159124,
    159915,159920,159928,159936,160716,160724,160724,160727,160732,161508,161508,161508,161511,162312,162315,162323,
    162323,163131,163135,163135,163143,163978,163986,163991,163991,163991,164827,164835,164835,164835,165646,165646,
    165651,165654,166445,166453,166458,166461,167270,167274,167282,167286,167286,168089,168097,168105,168110,168917,
    168925,168928,168928,169765,169773,169773,169781,170745,170748,170753,170753,170753
    ];
    var melody_data1 = [
    'A3','B3','E4','F3','F2','E4','F2','A3','B3','F3','E4','A3','B3','F3','A3','B3',
    'E4','F3','A3','B3','F3','E4','F3','B3','A3','E4','F2','E4','A3','F3','B3','A3',
    'B3','F3','E4','F3','A3','B3','E4','E2','G4','G3','C4','D4','C4','G3','D4','G4',
    'C4','G3','D4','G4','G4','G3','C4','D4','G4','C4','E2','G3','D4','G4','G3','C4',
    'D4','G4','G3','C4','D4','G4','G3','C4','D4','E5','F2','D5','C5','E4','F3','B3',
    'B4','A3','E4','B3','A3','F3','B3','E4','F3','A3','A4','D5','F2','B4','E4','B3',
    'F3','A3','E4','A3','F3','B3','E4','F3','B3','A3','A4','D5','E2','G4','C4','G3',
    'D4','G3','C4','D4','G3','C4','D4','E2','G3','G4','C4','D4','G4','G3','C4','D4',
    'G3','C4','G4','D4','E4','F2','E5','D5','C5','E4','B3','F3','A3','B4','E4','F3',
    'B3','A3','E4','B3','F3','A3','A4','D5','F2','B4','E4','B3','A3','F3','E4','A3',
    'B3','F3','E4','B3','F3','A3','A4','D5','E2','D5','C5','G5','C4','G3','D4','G4',
    'G4','C4','D4','G3','G4','G3','C4','D4','E2','G3','G4','C4','D4','G4','G3','C4',
    'D4','G4','D4','C4','G3','F2','E6','D6','C6','E4','B3','B5','F3','A3','E4','B3',
    'A3','F3','E4','B3','A3','F3','A5','D6','F2','B5','E4','B3','A3','F3','E4','B3',
    'F3','A3','F3','E4','B3','A3','A5','D6','E2','G5','G4','C4','G3','D4','G3','C4',
    'G4','D4','G4','G3','C4','D4','E2','G4','G3','C4','D4','G4','C4','G3','D4','G4',
    'C4','G3','D4','E5','F2','E6','D6','C6','E4','B3','A3','F3','B5','F3','E4','B3',
    'A3','E4','B3','F3','A3','A5','D6','F2','B5','E4','B3','F3','A3','E4','F3','B3',
    'A3','E4','F3','B3','A3','A5','D6','E2','D6','C6','G6','C4','G4','G3','D4','G4',
    'C4','D4','G3','G4','C4','D4','G3','E2','G4','C4','D4','G3','G4','C4','D4','G3',
    'G4','C4','D4','G3','G4','G4','F2','G5','F5','D#5','D#4','G3','C4','G#3','D5','D#4',
    'C4','G3','G#3','D#4','C4','G3','G#3','C5','F5','F2','D5','D#4','G#3','C4','G3','D#4',
    'C4','G3','G#3','D#4','G3','C4','G#3','C5','F5','G2','G5','D5','D5','D4','F4','A#3',
    'A3','D4','F4','A#3','A3','A3','F4','D4','A#3','G2','F4','D4','A3','A#3','D4','F4',
    'A#3','A3','F4','D4','A3','A#3','G4','F2','G5','F5','D#5','D#4','C4','G3','G#3','D5',
    'G3','D#4','C4','G#3','D#4','G3','C4','G#3','C5','F5','F2','D5','D#4','G3','G#3','C4',
    'D#4','C4','G3','G#3','D#4','G3','C4','G#3','C5','F5','B4','E2','G3','F#3','B3','B3',
    'F#3','G3','B3','F#3','G3','E2','G3','F#3','B3','B3','G3','F#3','B3','G3','F#3','F2',
    'B4','A4','G4','F4','A3','F3','B3','A3','F3','B3','F4','G4','A4','A3','B3','F3',
    'B4','A4','G4','F2','B4','A4','G4','F4','A3','B3','F3','A3','B3','F3','A3','B3',
    'F3','F4','G4','A4','E2','E4','B3','G3','F#3','F#3','G3','B3','G3','F#3','B3','E2',
    'B3','F#3','G3','F#3','G3','B3','F#3','G3','B3','F2','B6','A6','G6','F6','A3','F3',
    'B3','A3','B3','F3','F6','G6','A6','A3','B3','F3','B6','A6','G6','F2','B6','A6',
    'G6','A3','F3','F6','B3','A3','F3','B3','B3','A3','F3','F6','G6','A6','E2','E6',
    'G3','F#3','B3','B3','F#3','G3','F#3','B3','G3','E2','B3','F#3','G3','G3','F#3','B3',
    'B3','F#3','G3','F2','E5','D5','C5','E4','B3','A3','F3','B4','E4','B3','F3','A3',
    'E4','B3','A3','F3','A4','D5','F2','B4','E4','B3','A3','F3','E4','B3','F3','A3',
    'E4','F3','B3','A3','A4','D5','E2','G4','C4','G3','D4','G3','C4','D4','C4','G3',
    'D4','E2','G4','G3','C4','D4','G4','C4','G3','D4','G3','C4','G4','D4','E4','F2',
    'E5','D5','C5','E4','B3','F3','A3','B4','B3','E4','F3','A3','E4','B3','F3','A3',
    'A4','D5','F2','B4','E4','B3','A3','F3','E4','B3','F3','A3','E4','B3','F3','A3',
    'A4','D5','E2','D5','G5','C5','G4','C4','G3','D4','G3','G4','C4','D4','G4','G3',
    'C4','D4','E2','G3','C4','G4','D4','G3','C4','G4','D4','G3','G4','C4','D4','F2',
    'F3','A3','B3','E4','E4','F3','A3','B3','E4','B3','F3','A3','F3','E4','B3','A3',
    'F3','E4','A3','B3','F2','E4','A3','F3','B3','A3','B3','F3','E4','F3','B3','E4',
    'A3','G4','C4','G3','E2','D4','G4','C4','G3','D4','G4','C4','D4','G3','G4','C4',
    'G3','D4','E2','G4','C4','G3','D4','G3','C4','G4','D4','G4','C4','G3','D4','G4',
    'G3','C4','D4','E4','B3','A3','F2','F3','E4','A3','B3','F3','E4','F3','A3','B3',
    'B3','A3','F3','E4','F2','A3','B3','F3','E4','E4','B3','A3','F3','A3','B3','F3',
    'E4','E4','F3','A3','B3','C4','G4','E2','G3','D4','C4','G4','G3','D4','G3','C4',
    'D4','G4','C4','G4','G3','D4','G4','E2','C4','G3','D4','G4','C4','G3','D4','G4',
    'C4','G3','D4','C4','G4','G3','D4','E2','C4','G4','G3','D4'
    ];
    var melody_volume_ary1 = [
    27,26,24,26,23,44,45,53,55,50,47,47,47,39,39,44,
    39,39,47,50,50,33,41,47,51,33,35,33,45,39,43,45,
    44,46,31,47,57,57,34,49,67,61,63,70,49,45,47,38,
    40,40,52,49,38,42,48,52,49,53,44,53,61,44,46,47,
    51,47,41,49,49,45,42,46,49,88,56,68,65,37,37,41,
    69,39,36,32,38,31,38,36,37,38,74,75,48,74,40,42,
    40,45,35,45,36,34,39,38,42,45,81,84,52,74,45,37,
    39,37,47,39,37,37,37,62,47,43,51,54,42,42,46,51,
    42,55,37,52,94,61,92,70,74,42,50,47,55,72,45,38,
    50,49,46,50,41,46,81,84,53,68,40,47,47,39,40,52,
    50,35,42,47,38,48,83,70,52,78,56,63,50,38,45,35,
    39,46,40,33,36,37,41,46,65,36,42,54,49,44,31,46,
    49,43,46,48,32,64,97,80,83,42,47,67,37,35,43,43,
    46,38,37,42,42,42,84,92,54,77,44,43,46,39,36,42,
    35,43,35,40,42,42,81,74,43,70,34,48,37,45,41,47,
    45,43,42,43,48,41,65,46,36,41,41,40,45,37,42,46,
    49,37,39,97,60,94,62,78,47,55,53,40,73,36,38,41,
    44,41,44,42,46,75,77,59,69,44,50,37,43,37,35,37,
    42,47,41,50,50,90,83,61,90,59,68,49,43,37,45,42,
    44,45,40,44,49,43,44,57,43,52,48,37,49,54,52,37,
    81,47,54,37,86,92,61,94,72,62,45,42,51,36,86,33,
    43,34,30,39,52,40,33,81,77,59,81,39,33,42,33,36,
    50,39,34,41,40,49,33,99,88,64,92,61,70,51,49,39,
    39,47,40,35,36,41,45,48,35,69,44,50,36,37,51,48,
    39,34,51,52,40,35,74,61,105,72,59,44,48,36,37,83,
    40,44,57,40,40,40,54,36,68,69,58,74,35,39,32,41,
    33,44,35,32,36,37,42,32,92,84,70,53,38,31,32,37,
    31,39,40,35,45,54,47,33,40,40,47,37,47,54,45,35,
    43,46,51,51,53,47,38,42,36,33,54,62,69,56,46,53,
    72,62,51,52,50,49,51,59,47,42,47,39,32,40,42,34,
    33,69,66,69,43,68,34,37,32,31,37,37,41,34,39,56,
    37,40,43,33,38,37,37,44,40,58,70,72,61,57,56,51,
    41,48,39,41,92,77,66,52,44,49,69,57,64,61,78,68,
    50,53,53,74,42,50,44,39,39,48,44,70,73,70,57,61,
    43,34,31,41,39,46,41,44,49,53,32,35,38,33,28,29,
    37,36,42,64,86,72,77,42,49,49,37,73,40,44,45,55,
    47,50,56,43,88,79,59,81,45,47,52,47,43,46,42,48,
    42,35,47,48,81,79,57,77,52,45,39,43,51,45,47,40,
    43,61,47,50,44,58,40,43,45,48,44,52,41,54,68,59,
    81,74,70,39,43,43,49,69,37,35,44,50,42,42,35,46,
    64,67,57,75,39,45,46,37,39,45,37,46,47,49,41,50,
    90,84,55,84,66,66,45,37,28,39,36,41,48,43,36,34,
    43,43,52,39,45,37,44,37,48,37,43,24,41,43,39,50,
    43,42,40,32,39,41,44,47,42,41,38,40,40,38,46,41,
    40,37,41,43,43,39,39,42,45,41,40,35,32,44,47,40,
    47,64,56,54,52,61,46,49,47,58,42,42,53,44,45,48,
    49,58,46,48,55,50,61,45,42,42,51,41,43,42,43,43,
    40,47,51,34,37,33,39,34,36,39,36,30,38,38,41,47,
    47,42,42,37,41,40,45,37,33,36,40,39,34,28,35,29,
    33,42,45,45,49,49,35,38,42,47,39,36,38,40,36,37,
    40,32,45,36,35,43,40,45,44,40,46,37,40,37,41,37,
    44,39,45,44,39,42,44,40,46,38,41,47
    ];
    

var melody_length_ary = melody_length_ary1;
var melody_time_ary = melody_time_ary1;
var melody_data = melody_data1;
var melodyFlagAry = createBrankAry(melody_time_ary);

var countUp = 0;
var atCount = 0;
var startTime = new Date(), atTime = new Date(), diffTime = new Date();

var beforeX = 0, beforeY = 0;
var norm_threshold = 100;

document.addEventListener("DOMContentLoaded", function(){
    var ripple_wood = document.getElementById("ripple_div");
    
    ripple_wood.addEventListener("click", function (event) { 

        var norm = Math.sqrt( Math.pow(event.pageX - beforeX,2) + Math.pow(event.pageY - beforeY, 2));
        console.log(norm);
        beforeX = event.pageX;
        beforeY = event.pageY;

        var synth = new Tone.Synth().toMaster();
        //synth.volume.value = 1;
        if(count == 0){
            //startAccompaniment(accompaniment_time_ary, accompaniment_data);
            startAccompaniment(melody_time_ary1, melody_data1, melody_length_ary1, melody_volume_ary1, melodyFlagAry, false);
            //startAccompaniment(melody_time_ary2, melody_data2, melody_length_ary2, melodyFlagAry, false);

            //startAccompaniment(melody_time_ary3, melody_data3, melody_length_ary3, melodyFlagAry, false);
            //startAccompaniment(melody_time_ary4, melody_data4, melody_length_ary4, melodyFlagAry, false);
            //startAccompaniment(melody_time_ary5, melody_data5, melody_length_ary5, melodyFlagAry, false);
            //startAccompaniment(melody_time_ary6, melody_data6, melody_length_ary6, melodyFlagAry, false);
            //startAccompaniment(melody_time_ary7, melody_data7, melody_length_ary7, melodyFlagAry, false);

            Tone.Transport.start();
            startTime = new Date();
            atTime = new Date();
            countUp = 0;
            atCount = 0;
        }else{
            atTime = new Date();
        }
        diffTime = atTime.getTime() - startTime.getTime();
        //console.log(diffTime);
        
        var clickSuccessFlag = false;
        for(var i=atCount+1; i<melody_time_ary.length; i++){
           // music_scale = melody_data[countUp];
           // console.log(melody_time_ary[i] * BPNConvertMSEC);
            if((melody_time_ary[i]-100) <= diffTime + melody_time_ary[0]){
                atCount = i;
                clickSuccessFlag = true;
            }
        }

        var rand = Math.round(Math.random() * melody_data.length);
        console.log(rand);
        if(clickSuccessFlag){
            for(var i=atCount; i<atCount+10; i++){
                if(melody_time_ary[atCount] == melody_time_ary[i]){
                    if(melodyFlagAry[i] == 0){
                        if(norm > norm_threshold){
                            //console.log(norm);
                            music_scale = melody_data[i];
                        }
                        melodyFlagAry[i] = 1;
                        ++melodyFlagAry[i];
                    }else{
                        if(norm > norm_threshold){
                            console.log(norm);
                            music_scale = melody_data[rand];
                        }
                        //music_scale = 0;
                    }
                    synth.triggerAttackRelease(music_scale, melody_length_ary[i]);
                }
            }
        }else{
            if(norm > norm_threshold){
                music_scale = melody_data[rand];
            }else{
            }
            synth.triggerAttackRelease(music_scale, "8n");
        }
 
        //music_scale = melody_data[countUp];
        countUp++;

        if((melody_time_ary[melody_time_ary.length-1]) < diffTime){
            //Tone.Transport.stop();
            console.log("Over!");
            count = 0;
            melodyFlagAry = createBrankAry(melody_time_ary);
        }
        else{
            count++;
        }
    }, false);

}, false);

function waitNote(msec, count, mainFlag, flagAry){
    var objDef = new $.Deferred;
    setTimeout(function(){
        objDef.resolve(count, mainFlag, flagAry);
    }, msec);
    return objDef.promise(count, mainFlag, flagAry);
}

function startAccompaniment(timeAry, dataAry, lengthAry, volumeAry, flagAry, mainFlag){
    var synth = new Tone.Synth().toMaster();
    for(var i=0; i<timeAry.length; i++){
        var nextTime = timeAry[i] - melody_time_ary[0];

        waitNote(nextTime, i, mainFlag, flagAry).done(function(count, mainFlag){
            if(mainFlag){
                if(flagAry[count] == 0){
                    synth.volume.value = -1*(127 - volumeAry[count])/2;
                    //synth.volume.value = -20;
                    var scale = dataAry[count];
                    synth.triggerAttackRelease(scale, lengthAry[count]);
                }
            }
            else{
                synth.volume.value = -1*(127 - volumeAry[count])/2;
                var scale = dataAry[count];
                synth.triggerAttackRelease(scale, lengthAry[count]); 
            }
        });
    }
}

function createBrankAry(ary){
    var tempAry = {};
    for(var i=0; i<ary.length; i++){
        tempAry[i] = 0;
    }
    return tempAry;
}
