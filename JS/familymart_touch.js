var music_scale;
var ToneBPM = 140;
var BPNConvertMSEC = 60 / ToneBPM * 1000;
Tone.Transport.bpm.value = ToneBPM;
console.log(BPNConvertMSEC);

var count = 0;
/*
var melody_time_ary = [
    3335,3668,4001,4334,4667,5000,5333,5666,
    5999,6999,7332,7665,7998,8998,9331,9664,
    9997,10997,11330,11663,11996,12329,12662,12995,
    13328,13661,13994,14994,15327,15660,15993,16993,
    17326,17659,17992,19325,19658,19991,20324,20657,
    20990,21323,21656,21989,22989,23322,23655,23988,
    24988,25321,25654,25987,26987,27320,27653,27986,
    28319,28652,28985,29318,29651,29984,30984,31317,
    31650,31983,32983,33316,33649,33982,34982,35315,
    35648,35981,36980,37313,37646,37979,38978,39311,
    39644,39977,40976,41309,41642,41975,42642,42975,
    43308,43975,44308,44641,44974,45307,45640,45973,
    46306,46639,46972,47305,47638,47971,48304,48637,
    48970,49303,49636,49969,50969,51302,51635,51968,
    52968,53301,53634,53967,54967,55300,55633,55966,
    56299,56632,56965,57298,57631,57964,58964,59297,
    59630,59963,60963,61296,61629,61962,61962
    ];
    var melody_data = [
    'E5','D#5','E5','D#5','E5','B4','D5','C5',
    'A4','C4','E4','A4','B4','E4','G#4','B4',
    'C5','E4','E5','D#5','E5','D#5','E5','B4',
    'D5','C5','A4','C4','E4','A4','B4','E4',
    'C5','B4','A4','E5','D#5','E5','D#5','E5',
    'B4','D5','C5','A4','C4','E4','A4','B4',
    'E4','G#4','B4','C5','E4','E5','D#5','E5',
    'D#5','E5','B4','D5','C5','A4','C4','E4',
    'A4','B4','E4','C5','B4','A4','B4','C5',
    'D5','E5','G4','F5','E5','D5','F4','E5',
    'D5','C5','E4','D5','C5','B4','E4','E4',
    'E5','E5','E5','E6','D#5','E5','D#5','E5',
    'D#5','E5','D#5','E5','D#5','E5','D#5','E5',
    'B4','D5','C5','A4','C4','E4','A4','B4',
    'E4','G#4','B4','C5','E4','E5','D#5','E5',
    'D#5','E5','B4','D5','C5','A4','C4','E4',
    'A4','B4','D4','C5','B4','A4','C4'
    ];
var accompaniment_time_ary = [
    5999,6666,7998,8665,9997,10664,13994,14661,
    15993,16660,17992,21989,22656,23988,24655,25987,
    26654,29984,30651,31983,32650,33982,36314,36647,
    38312,38645,40310,40643,41975,41975,49969,50636,
    51968,52635,53967,54634,57964,58631,59963,60630,
    61962,61962
    ];
var accompaniment_data = [
    'A3','E3','G#3','E3','A3','E3','A3','E3',
    'G#3','E3','A3','A3','E3','G#3','E3','A3',
    'E3','A3','E3','G#3','E3','A3','G3','C4',
    'G3','B3','A3','C4','E3','G#3','A3','E3',
    'G#3','E3','A3','E3','A3','E3','G#3','E3',
    'A2','E3'
];
*/

var melody_time_ary1 = [
    0,666,1541,2563,2896,3896,4740,7939,8783,9116,10116,10960,14159,15181,15514,16514,
    17358,19046,50535,51201,52045,53067,53400,54400,55244,58443,59287,59620,60620,61464,64663,65685,
    66018,67018,67862,69550,147161,148183,148516,149516,150360,153559,154403,154736,155736,156580,159779,160801,
    161134,162134,162978,164666,192601,193267,194111,195311,195644,196644,197488,200687,201531,201864,202864,203708,
    206907,207929,208262,209262,210106,211825
    ];
    var melody_data1 = [
    'F#5','G5','A5','A5','A5','A5','A5','A5','A5','A5','A5','A5','F#5','F#5','F#5','F#5',
    'F#5','B5','F#5','G5','A5','A5','A5','A5','A5','A5','A5','A5','A5','A5','F#5','F#5',
    'F#5','F#5','F#5','B5','A5','A5','A5','A5','A5','A5','A5','A5','A5','A5','F#5','F#5',
    'F#5','F#5','F#5','B5','F#5','G5','A5','A5','A5','A5','A5','A5','A5','A5','A5','A5',
    'F#5','F#5','F#5','F#5','F#5','B5'
    ];
    var melody_time_ary2 = [
    0,522,689,856,11109,11442,11775,12108,12619,13819,14152,17684,18017,18350,18683,19194,
    20038,20371,21037,21703,23902,24235,24568,24901,25412,26434,26767,30299,30632,30965,31298,31809,
    32653,32986,33652,34318,36548,37214,38058,38058,39080,39080,39413,39413,40413,40413,41257,41257,
    42279,42612,43612,43945,44456,44456,45300,45300,45633,45633,46633,46633,47477,48499,48832,49832,
    50165,50676,50676,51698,51698,52031,52031,53031,53031,53875,54897,55563,55785,56007,56229,57073,
    58584,58584,58584,59584,59584,59584,60095,60095,60095,61117,63325,64014,64347,64680,65013,65346,
    65679,66012,66523,67212,67545,67878,68211,68544,68877,69210,69721,70232,70565,70898,71231,71564,
    71897,72230,72741,73430,73763,74096,74429,74762,75095,75428,75939,76628,76961,77294,77627,77960,
    78293,78626,79137,79826,80159,80492,80825,81158,81491,81824,82335,82846,83179,83512,83845,84178,
    84511,84844,85355,87074,87740,88584,88584,89606,89606,89939,89939,90939,90939,91783,91783,92805,
    93138,94138,94471,94982,94982,95826,95826,96159,96159,97159,97159,98003,99025,99358,100358,100691,
    101202,101202,102224,102224,102557,102557,103557,103557,104401,106089,106311,106533,106755,107088,107630,145207,
    145873,146562,146895,147228,147561,147894,148227,148560,149071,149760,150093,150426,150759,151092,151425,151758,
    152269,152780,153113,153446,153779,154112,154445,154778,155289,155978,156311,156644,156977,157643,158518,159207,
    159540,159873,160206,160539,160872,161205,161716,162405,162738,163071,163404,163737,164070,164403,164914,165425,
    165758,166091,166424,166757,167090,167423,167934,168623,168956,169289,169622,169955,170288,170621,171132,171821,
    172154,172487,172820,173153,173486,173819,174330,175019,175352,175685,176018,176351,176684,177017,177528,178039,
    178372,178705,179038,179371,179704,180037,180548,181237,181570,181903,182236,182569,182902,183235,183746,183746,
    184768,184768,185101,185101,186101,186101,186945,186945,187967,188300,189300,189633,190144,190144,190988,190988,
    191321,191321,192321,192321,193165,194187,194520,195520,195853,196364,196364,197386,197386,197719,197719,198719,
    198719,199563,200585,201251,201473,201695,201917,202792,204303,204303,204303,205303,205303,205303,205845,205845,
    205845,206867,207564,208075,208408,208741,209074,209740,210073,213072,213405,213738,214071,214404,215070,215403,
    216069,216735,218401,218734,219067,219400,219733,220399,220732,223731,224064,224397,224730,225063,225729,226062,
    226728,227394,229269,229935,230779,230779,231979,231979,232312,232312,233312,233312,234156,234156,235178,235511,
    236511,236844,237355,237355,238199,238199,238532,238532,239532,239532,240376,241398,241731,242731,243064,243575,
    243575,244597,244597,244930,244930,245930,245930,246774,246774,248493,248715,248937,249159,249492,250034,261142,
    261475,261808,262141,262652,263496,263829,273760,274093,274426,274759,275270,276114,276447,286378,286711,287044,
    287377,287888,288732,289065,290909,290909,292264,292264,293264,293264,294108,294108
    ];
    var melody_data2 = [
    'A4','D5','E5','A5','A4','D5','E5','F#5','E5','D5','D5','A4','D5','E5','F#5','E5',
    'D5','E5','F#5','F#5','A4','D5','E5','F#5','E5','D5','D5','A4','D5','E5','F#5','E5',
    'D5','E5','A5','F#5','F#4','G4','A4','C#5','A4','C#5','A4','C#5','A4','C#5','D5','B4',
    'F#5','D5','F#5','G5','A4','C#5','A4','C#5','A4','C#5','A4','C#5','A4','F#5','D5','D5',
    'E5','D5','G#4','D5','G#4','G#4','D5','G#4','D5','B4','B5','E5','F#5','E5','D5','E5',
    'E5','B4','G4','E5','B4','G4','E5','B4','G4','C#5','D5','E5','F#5','E5','F#5','E5',
    'F#5','E5','D5','E5','F#5','E5','F#5','E5','F#5','E5','D5','E5','F#5','E5','F#5','E5',
    'F#5','E5','D5','E5','F#5','E5','F#5','E5','F#5','E5','D5','E5','F#5','E5','F#5','E5',
    'F#5','E5','D5','E5','F#5','E5','F#5','E5','F#5','E5','D5','E5','F#5','E5','F#5','E5',
    'F#5','E5','D5','F#4','G4','A4','C#5','A4','C#5','A4','C#5','A4','C#5','D5','B4','F#5',
    'D5','F#5','G5','A4','C#5','A4','C#5','A4','C#5','A4','C#5','A4','F#5','D5','D5','E5',
    'D5','G#4','D5','G#4','G#4','D5','D5','G#4','G4','E5','F#5','E5','D5','B4','D5','B4',
    'F#5','B4','D5','E5','F#5','A4','D5','E5','G4','B4','D5','E5','D5','C#5','B4','A4',
    'B4','F#4','G4','A4','B4','E4','F#4','G4','A4','D4','F#4','A4','A4','D5','A5','A4',
    'D5','E5','A5','E5','D5','A4','A5','A4','D5','E5','A5','E5','D5','A4','A5','A4',
    'D5','E5','A5','E5','D5','A4','A5','A4','D5','A5','A4','D5','A5','A4','A5','A4',
    'D5','E5','A5','E5','D5','A4','A5','A4','D5','E5','A5','E5','D5','A4','A5','A4',
    'D5','E5','A5','E5','D5','A4','A5','A4','D5','E5','A5','E5','D5','A4','A4','C#5',
    'A4','C#5','A4','C#5','A4','C#5','D5','B4','F#5','D5','F#5','G5','A4','C#5','A4','C#5',
    'A4','C#5','A4','C#5','A4','F#5','D5','D5','E5','D5','G#4','D5','G#4','G#4','D5','G#4',
    'D5','B4','B5','E5','F#5','E5','D5','E5','E5','B4','G4','E5','B4','G4','E5','B4',
    'G4','C#5','A4','D5','E5','F#5','E5','D5','D5','A4','D5','E5','F#5','E5','D5','E5',
    'F#5','F#5','A4','D5','E5','F#5','E5','D5','D5','A4','D5','E5','F#5','E5','D5','E5',
    'A5','F#5','F#4','G4','A4','C#5','A4','C#5','A4','C#5','A4','C#5','D5','B4','F#5','D5',
    'F#5','G5','A4','C#5','A4','C#5','A4','C#5','A4','C#5','A4','F#5','D5','D5','E5','D5',
    'G#4','D5','G#4','G#4','D5','G#4','D5','G4','D5','E5','F#5','E5','D5','B4','D5','A4',
    'D5','E5','F#5','E5','D5','D5','A4','D5','E5','F#5','E5','D5','D5','A4','D5','E5',
    'F#5','E5','D5','D5','B4','B3','A4','A3','G4','G3','F#4','F#3'
    ];
    var melody_time_ary3 = [
    0,1230,1896,2562,3437,4490,5156,5822,6697,7572,8238,8904,9779,10832,11498,12164,
    13039,14092,14758,15424,16299,17352,18018,18684,19559,20434,21100,21766,22641,23694,24360,25026,
    25870,26892,27558,28224,29068,30090,30756,31422,32266,33110,33776,34442,35286,36308,36974,37640,
    38484,39506,40172,40838,41682,42704,43370,44036,44880,45724,46390,47056,47900,48922,49588,49588,
    49588,51099,52121,52787,53453,54328,55381,56047,56713,57588,58463,59129,59795,60670,61723,62389,
    63055,63930,64983,65649,66315,67190,68243,68909,69575,70450,71325,71991,72657,73532,74585,75251,
    75917,76761,77783,78449,79115,79959,80981,81647,82313,83157,84001,84667,85333,86177,87199,87865,
    88531,89375,90397,91063,91729,92573,93595,94261,94927,95771,96615,97281,97947,98791,99813,100479,
    145121,145121,145787,145787,146662,147684,148350,149016,149860,150882,151548,152214,153089,153933,154599,155265,
    156109,156109,157495,157495,158525,158525,159400,160422,161088,161754,162598,163620,164286,164952,165827,166671,
    167337,168003,168847,168847,170233,170233,171263,171263,172138,172138,173826,173826,175337,175337,177025,177025,
    178536,178536,180047,180047,181558,181558,183246,183246,184757,184757,186445,186445,187956,187956,189644,189644,
    191185,191185,192029,192695,192695,194236,195258,195924,195924,197465,198131,198797,199463,200129,200795,201461,
    202127,202793,203459,204125,204791,205457,206123,206789,207455,208121,208787,209453,210119,210785,211451,212117,
    212783,213449,214115,214781,215447,216144,216988,217654,218320,219164,220364,221030,221696,222540,223562,224228,
    224894,225738,226582,227248,227914,228758,229780,230446,231112,231956,232978,233644,234310,235154,235154,238353,
    239197,239863,240529,241373,242395,243061,243727,244571,245593,246259,246925,247769,248791,249457,250123,250967,
    251811,252477,253143,253987,255009,255675,256341,257185,258207,258873,259539,260383,261405,262071,262737,263581,
    264425,265091,265757,266601,267623,268289,268955,269799,270821,271487,272153,272997,274019,274685,276226,276226,
    279278,279278,280633,280633,281633,281633,282477,282477
    ];
    var melody_data3 = [
    'B2','F#3','B3','F#3','G2','D3','G3','D3','A2','E3','A3','E3','D3','A3','D4','A3',
    'B2','F#3','B3','F#3','G2','D3','G3','D3','A2','E3','A3','E3','D3','A3','D4','A3',
    'A2','E3','A3','E3','G2','D3','G3','D3','F#2','C#3','A3','C#3','B2','F#3','B3','F#3',
    'E2','B2','E3','B2','G2','D3','G3','D3','A2','E3','A3','E3','A2','E3','A3','A2',
    'A1','B2','F#3','B3','F#3','G2','D3','G3','D3','A2','E3','A3','E3','D3','A3','D4',
    'A3','B2','F#3','B3','F#3','G2','D3','G3','D3','A2','E3','A3','E3','D3','A3','D4',
    'A3','A2','E3','A3','E3','G2','D3','G3','D3','F#2','C#3','A3','C#3','B2','F#3','B3',
    'F#3','E2','B2','E3','B2','A2','E3','A3','E3','D2','A2','D3','F#3','A3','F#3','D3',
    'A2','A3','D3','D4','D2','A2','D3','E3','E2','B2','E3','F#3','F#2','C#3','F#3','A3',
    'G3','G2','F#3','F#2','E3','E2','D2','A2','D3','E3','E2','B2','E3','F#3','F#2','C#3',
    'F#3','A3','G3','G2','F#2','F#3','E3','E2','A1','A2','A3','E3','G2','G1','D3','G3',
    'F#2','F#1','C#3','A3','B2','B1','F#3','B3','E1','E2','B2','E3','G1','G2','D3','G3',
    'A1','A2','E3','E3','A3','A2','E3','E3','A3','B2','F#3','B3','F#3','G2','D3','G3',
    'D3','A2','E3','A3','E3','D3','A3','D4','A3','B2','F#3','B3','F#3','G2','D3','G3',
    'D3','A2','E3','A3','E3','D3','A3','D4','A3','A2','E3','A3','E3','G2','D3','G3',
    'D3','F#2','C#3','A3','C#3','B2','F#3','B3','F#3','E2','B2','E3','B2','A2','A1','D2',
    'A2','D3','A2','B2','F#3','B3','F#3','G2','D3','G3','D3','A2','E3','A3','E3','D2',
    'A2','D3','A2','B2','F#3','B3','F#3','G2','D3','G3','D3','A2','E3','A3','E3','D2',
    'A2','D3','A2','B2','F#3','B3','F#3','G2','D3','G3','D3','A2','E3','A3','D2','D3',
    'G3','G2','F#3','F#2','E3','E2','D3','D2'
    ];
    var melody_time_ary4 = [
    0,728,1061,1394,2060,2726,3392,4058,4724,5390,6056,6722,7388,8054,8720,9053,
    9781,10145,11722,12388,13054,13720,14386,15052,15718,16384,17050,17716,18382,19048,19714,20047,
    20713,21046,21835,22501,23167,23833,24499,25165,25831,26497,27163,27829,28495,29161,29827,30493,
    30826,31492,31856,32645,35769,38924,42018,45142,48266,51390,54484,57517,58306,58972,59669,60458,
    61247,61913,62610,63399,64188,64854,65551,66340,67129,67795,68492,69281,70070,70736,71433,72222,
    73011,73677,74374,75163,75952,76618,77315,78104,79681,79903,80125,80378,80575,80772,80969,81166,
    84229,87353,89719,90508,93663,96726,99000,99789,101761,102155,102549,102943,127426,128215,128609,129003,
    129731,130459,131248,131642,132036,132764,133492,134281,134675,135069,135797,136525,137314,137708,138102,138830,
    139558,140347,140741,141135,141863,142591,143380,143774,144168,144896,145624,146413,146807,147201,147929,148657,
    149446,149840,150234,150962,151690,154845,158000,161155,162338,163521,164310,167465,170620,173775,174958,176141,
    177596,178324,180568,181296,183540,184268,186512,187240,189484,190212,192456,193184,195428,196156,200369,200702,
    201035,201368,201701,202034,202367,202700,203033,203366,203699,204032,204365,204698,205031,205364,205697,206030,
    206363,206696,207029,207362,207695,208028,208361,208694,209027,209360,209693,210026,210359,210692,211025,211358,
    211691,212024,212357,212690,213023,213356,213689,214022,214355,214688,215021,215354,215687,216020,216353,216686,
    217019,217352,217685,218018,218351,218684,219017,219350,219683,220016,220349,220682,221015,221348,221712,224836,
    227991,231085,234209,237333,241851,243428,245733,246522,254134,255711,258016,258805,266386,267963,270299,271088,
    279789,280972,282155,282944
    ];
    var melody_data4 = [
    'B5','F#5','F#5','B5','F#5','B5','F#5','B5','F#5','B5','F#5','B5','F#5','B5','F#5','B5',
    'F#5','B5','F#5','B5','F#5','B5','F#5','B5','F#5','B5','F#5','B5','F#5','B5','F#5','B5',
    'F#5','B4','B5','F#5','B5','F#5','B5','F#5','B5','F#5','B5','F#5','B5','F#5','B5','F#5',
    'B5','F#5','B5','A4','G4','F#4','B4','F#4','F#4','F#4','A4','B4','F#5','B5','F#5','G4',
    'D5','G5','D5','A4','E5','A5','E5','D5','A5','D6','A5','B4','F#5','B5','F#5','G4',
    'D5','G5','D5','A4','E5','A5','E5','D5','D4','F#4','A4','D5','E5','F#5','G5','A5',
    'G5','F#5','A5','B5','E5','A5','F#5','D5','A5','D6','A5','A6','B5','F#5','A5','B5',
    'F#5','B5','F#5','A5','B5','F#5','B5','F#5','A5','B5','F#5','B5','F#5','A5','B5','F#5',
    'B5','F#5','A5','B5','F#5','B5','F#5','A5','B5','F#5','B5','F#5','A5','B5','F#5','B5',
    'F#5','A5','B5','F#5','F#4','G4','A4','B4','A4','G4','F#4','G4','A4','B4','A4','G4',
    'A4','A4','G4','G4','F#4','F#4','B4','B4','B4','B4','B4','B4','A4','A4','B4','F#5',
    'B5','F#5','D6','F#5','B5','F#5','G4','D5','G5','D5','A5','D5','G5','D5','A4','E5',
    'A5','E5','B5','E5','A5','E5','D4','A4','D5','A5','G5','F#5','E5','D5','B4','F#5',
    'B5','F#5','D6','F#5','B5','F#5','G4','D5','G5','D5','A5','D5','G5','D5','A4','E5',
    'A5','E5','B5','E5','A5','E5','D4','A4','D5','A4','D5','A4','B4','G4','A4','G4',
    'F#4','B4','E4','A5','D6','C#6','A5','F#5','D6','C#6','A5','B5','D6','C#6','A5','F#5',
    'B4','A4','G4','F#4'
    ];
    var melody_time_ary5 = [
    0,3094,6218,9312,12403,15497,18621,21715,24836,27869,30902,33904,36903,39936,42969,45971,
    48942,52066,55190,58284,61408,64532,67656,73810,76843,79906,82939,85969,89032,92095,95066,98099,
    101254,104378,107502,110657,113751,116845,117239,117633,118027,118421,118815,119209,119603,119997,133782,136876,
    140000,143094,146185,149279,152403,155497,158588,161682,164806,167900,170994,174149,177304,180459,181642,182825,
    183614,186769,189924,193079,194262,195445,196900,197628,199872,200600,202844,203572,205816,206544,208788,209516,
    211760,212488,214732,215460,219731,222764,225797,228799,231798,234831,237864,240866,243837,246961,250085,253179,
    256303,259427,263915,265492,267797,268586,276198,277775,280080,280869,288450,290027,292363,293152,301853,302975,
    304066,304855
    ];
    var melody_data5 = [
    'F#4','D4','E4','A3','F#4','D4','E4','A3','F#4','D4','E4','A3','F#4','D4','E4','A3',
    'C#4','B3','A3','D4','G3','B3','C#4','F#4','D4','E4','A3','F#4','D4','E4','A3','C#4',
    'B3','A3','D4','G3','C#4','D3','A3','D4','F#4','A4','F#4','D5','A4','F#4','F#4','D4',
    'E4','A3','F#4','D4','E4','A3','F#4','D4','E4','A3','D4','E4','F#4','G4','F#4','E4',
    'D4','E4','F#4','G4','F#4','E4','E4','E4','D4','D4','C#4','C#4','F#4','F#4','F#4','F#4',
    'F#4','F#4','E4','E4','F#4','D4','E4','A3','F#4','D4','E4','A3','C#4','B3','A3','D4',
    'G3','C#4','D5','C#5','A4','F#4','D5','C#5','A4','B4','D5','C#5','A4','F#4','G4','F#4',
    'E4','D4'
    ];
    var melody_time_ary6 = [
    0,3063,6126,9159,12222,15285,18348,21381,24444,27507,30570,33603,36694,39696,42637,45608,
    48668,51670,54611,57582,60615,63770,66894,70018,73112,76236,79360,85453,88486,91488,94582,97673,
    100675,103677,106710,109804,112928,116022,119146,122270,125425,128580,145309,148372,151435,154468,157531,160594,
    163657,166690,169753,172816,175879,178912,181975,185130,188285,191440,192623,193806,194595,197750,200905,204060,
    205243,206426,207881,208609,210853,211581,213825,214553,216797,217525,219769,220497,222741,223469,225743,226440,
    230711,233713,236654,239625,242685,245687,248628,251599,254632,257787,260911,264035,267129,270253,274741,276318,
    278684,279473,287116,288693,291059,291848,299491,301068,303434,304223,313015,314167,315289,316078
    ];
    var melody_data6 = [
    'D4','B3','C#4','F#3','D4','B3','C#4','F#3','D4','B3','C#4','F#3','D4','B3','C#4','F#3',
    'D4','B3','C#4','F#3','E4','D4','C#4','F#4','B3','D4','E4','D4','B3','C#4','F#3','D4',
    'B3','C#4','F#3','E4','D4','C#4','F#4','B3','E4','A4','D4','B3','C#4','F#3','D4','B3',
    'C#4','F#3','D4','B3','C#4','F#3','A3','B3','C#4','D4','C#4','B3','A3','B3','C#4','D4',
    'C#4','B3','C#4','C#4','B3','B3','A3','A3','D4','D4','D4','D4','D4','D4','C#4','C#4',
    'D4','B3','C#4','F#3','D4','B3','C#4','F#3','E4','D4','C#4','F#4','B3','E4','B4','A4',
    'F#4','D4','B4','A4','F#4','G4','B4','A4','F#4','D4','D4','C#4','B3','A3'
    ];
    var melody_time_ary7 = [
    0,3094,6096,9067,12066,15160,18162,21133,24132,27226,30228,33199,36198,39292,42294,45265,
    48264,51266,54268,57270,60269,63271,66273,69275,72246,75279,78342,81405,84407,87501,90595,96657,
    99659,102661,105663,108662,111664,114666,117668,120639,123672,126705,129738,132740,135773,138836,144929,148023,
    151025,153996,156995,160089,163091,166062,169061,172155,175157,178128,181127,184221,187223,190194,193165,196167,
    199169,202171,203293,204415,205204,208206,211208,214210,215332,216454,218576,221456,224336,227216,230096,232976,
    235856,240097,243099,246101,249103,252102,255104,258106,261108,264079,267112,270175,273238,276240,279334,282486,
    285580,288582,291553,294552,297646,300648,303619,306618,309712,312714,315685,321322,322474,323596,324354
    ];
    var melody_data7 = [
    'B2','G2','A2','D2','B2','G2','A2','D2','B2','G2','A2','D2','B2','G2','A2','D2',
    'B2','G2','A2','D2','B2','G2','A2','D2','A2','G2','F#2','B2','E2','G2','A2','B2',
    'G2','A2','D2','B2','G2','A2','D2','A2','G2','F#2','B2','E2','A2','D2','B2','G2',
    'A2','D2','B2','G2','A2','D2','B2','G2','A2','D2','B2','G2','A2','D2','D2','E2',
    'F#2','G2','F#2','E2','D2','E2','F#2','G2','F#2','E2','A2','G2','F#2','B2','E2','G2',
    'A2','B2','G2','A2','D2','B2','G2','A2','D2','A2','G2','F#2','B2','E2','A2','D3',
    'B2','G2','A2','D3','B2','G2','A2','D3','B2','G2','A2','G2','F#2','E2','D2'
    ];
    
var melody_time_ary = melody_time_ary2;
var melody_data = melody_data2;
var nextTime = 0;


var countUp = 0;
var beforeCount = 0;
var startTime = new Date(), atTime = new Date(), diffTime = new Date();

document.addEventListener("DOMContentLoaded", function(){

    var ripple_wood = document.getElementById("ripple_div");

    ripple_wood.addEventListener("click", function () { 
        var synth = new Tone.Synth().toMaster();

        if(count == 0){
            //startAccompaniment(accompaniment_time_ary, accompaniment_data);
            //startAccompaniment(melody_time_ary1, melody_data1);
            startAccompaniment(melody_time_ary2, melody_data2);
            //startAccompaniment(melody_time_ary3, melody_data3);
            //startAccompaniment(melody_time_ary4, melody_data4);
            //startAccompaniment(melody_time_ary5, melody_data5);
            //startAccompaniment(melody_time_ary6, melody_data6);
            //startAccompaniment(melody_time_ary7, melody_data7);
            Tone.Transport.start();
            startTime = new Date();
            atTime = new Date();
        }
        else{
            atTime = new Date();
        }
        diffTime = atTime.getTime() - startTime.getTime();
        console.log(diffTime);

        
        for(var i=beforeCount; i<melody_time_ary.length; i++){
            music_scale = melody_data[countUp];
           // console.log(melody_time_ary[i] * BPNConvertMSEC);
            if((melody_time_ary[i]-1) <= diffTime + melody_time_ary[0]){
                music_scale = melody_data[i];
                beforeCount = i+1;
            }
        }

        //music_scale = melody_data[countUp];
        countUp++;
        synth.triggerAttackRelease(music_scale, "8n"); 

        if((melody_time_ary[melody_time_ary.length]) < diffTime){
            Tone.Transport.stop();
            count = 0;
        }
        else{
            count++;
        }
    }, false);

}, false);

function waitNote(msec, count){
    var objDef = new $.Deferred;
    setTimeout(function(){
        objDef.resolve(count);
    }, msec);
    return objDef.promise(count);
}

function startAccompaniment(timeAry, dataAry){
    var synth = new Tone.Synth().toMaster();
    for(var i=0; i<timeAry.length; i++){
        nextTime = timeAry[i] - melody_time_ary[0];

        waitNote(nextTime, i).done(function(count){
            var scale = dataAry[count];
            synth.triggerAttackRelease(scale, 0.5); 
            console.log(count);
        });
    }
}
